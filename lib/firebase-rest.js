"use strict";
var Promise = require('promise');
var https = require('https');
var util = require('./util');
var querystring = require('querystring');
var uuid = require('node-uuid');
var firebase = require('firebase');
var FIREBASE_HOST = 'firebaseio.com';
var DEBUG_HEADER = 'x-firebase-auth-debug';
exports.RULES_LOCATION = '/.settings/rules';
exports.TIMESTAMP = { ".sv": "timestamp" };
function Client(appName, secret) {
    this.appName = appName;
    this.secret = secret;
}
exports.Client = Client;
util.methods(Client, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = true;
        }
        this.debug = debug;
        return this;
    },
    get: function (location) {
        return this.request({ method: 'GET' }, location);
    },
    put: function (location, content) {
        return this.request({ method: 'PUT', print: 'silent' }, location, content);
    },
    request: function (opt, path, content) {
        var options = {
            hostname: this.appName + '.' + FIREBASE_HOST,
            path: path + '.json',
            method: opt.method
        };
        var query = {};
        if (opt.print) {
            query.print = opt.print;
        }
        query.auth = this.secret;
        if (Object.keys(query).length > 0) {
            options.path += '?' + querystring.stringify(query);
        }
        content = util.prettyJSON(content);
        return request(options, content, this.debug)
            .then(function (body) {
            return body === '' ? null : JSON.parse(body);
        });
    }
});
var ridNext = 0;
function request(options, content, debug) {
    ridNext += 1;
    var rid = ridNext;
    function log(s) {
        if (debug) {
            console.log("Request<" + rid + ">: " + s);
        }
    }
    log("Request: " + util.prettyJSON(options));
    if (content) {
        log("Body: '" + content + "'");
    }
    return new Promise(function (resolve, reject) {
        var req = https.request(options, function (res) {
            var chunks = [];
            res.on('data', function (body) {
                chunks.push(body);
            });
            res.on('end', function () {
                var result = chunks.join('');
                log("Result (" + res.statusCode + "): '" + result + "'");
                if (Math.floor(res.statusCode / 100) !== 2) {
                    var message = "Status = " + res.statusCode + " " + result;
                    if (res.headers[DEBUG_HEADER]) {
                        var formattedHeader = res.headers[DEBUG_HEADER].split(' /').join('\n  /');
                        log(formattedHeader);
                        message += "\n" + formattedHeader;
                    }
                    reject(new Error(message));
                }
                else {
                    resolve(result);
                }
            });
        });
        if (content) {
            req.write(content, 'utf8');
        }
        req.end();
        req.on('error', function (error) {
            log("Request error: " + error);
            reject(error);
        });
    });
}
function generateUidAuthToken(username) {
    var uid = uuid.v4();
    var fbClient = firebase.initializeApp({
        databaseURL: "https://maintestapp.firebaseio.com/",
        serviceAccount: "./serviceAccountCredentials.json",
        databaseAuthVariableOverride: {
            uid: uid
        }
    }, uid);
    fbClient.uid = uid;
    return fbClient;
}
exports.generateUidAuthToken = generateUidAuthToken;
var PUSH_CHARS = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';
var lastPushTime = 0;
var lastRandChars = [];
function generatePushID() {
    var now = new Date().getTime();
    var duplicateTime = (now === lastPushTime);
    lastPushTime = now;
    var timeStampChars = new Array(8);
    for (var i = 7; i >= 0; i--) {
        timeStampChars[i] = PUSH_CHARS.charAt(now % 64);
        now = Math.floor(now / 64);
    }
    if (now !== 0) {
        throw new Error('We should have converted the entire timestamp.');
    }
    var id = timeStampChars.join('');
    if (!duplicateTime) {
        for (i = 0; i < 12; i++) {
            lastRandChars[i] = Math.floor(Math.random() * 64);
        }
    }
    else {
        for (i = 11; i >= 0 && lastRandChars[i] === 63; i--) {
            lastRandChars[i] = 0;
        }
        lastRandChars[i]++;
    }
    for (i = 0; i < 12; i++) {
        id += PUSH_CHARS.charAt(lastRandChars[i]);
    }
    if (id.length !== 20) {
        throw new Error('Length should be 20.');
    }
    return id;
}
exports.generatePushID = generatePushID;

//# sourceMappingURL=data:application/json;base64,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QUFjLGlCQW9DN0IsQ0FBQSIsImZpbGUiOiJmaXJlYmFzZS1yZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogRmlyZWJhc2UgaGVscGVyIGZ1bmN0aW9ucyBmb3IgUkVTVCBBUEkgKHVzaW5nIFByb21pc2VzKS5cclxuICpcclxuICogQ29weXJpZ2h0IDIwMTUgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICpcclxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuICpcclxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG4gKlxyXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXHJcbiAqL1xyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9ub2RlLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9lczYtcHJvbWlzZS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3Mvbm9kZS11dWlkLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9maXJlYmFzZS5kLnRzXCIgLz5cclxuaW1wb3J0IFByb21pc2UgPSByZXF1aXJlKCdwcm9taXNlJyk7XHJcbmltcG9ydCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XHJcbmltcG9ydCBodHRwID0gcmVxdWlyZSgnaHR0cCcpO1xyXG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpO1xyXG5pbXBvcnQgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpO1xyXG5pbXBvcnQgdXVpZCA9IHJlcXVpcmUoJ25vZGUtdXVpZCcpO1xyXG5cclxudmFyIGZpcmViYXNlID0gcmVxdWlyZSgnZmlyZWJhc2UnKTtcclxuXHJcbnZhciBGSVJFQkFTRV9IT1NUID0gJ2ZpcmViYXNlaW8uY29tJztcclxudmFyIERFQlVHX0hFQURFUiA9ICd4LWZpcmViYXNlLWF1dGgtZGVidWcnO1xyXG5cclxuZXhwb3J0IHZhciBSVUxFU19MT0NBVElPTiA9ICAnLy5zZXR0aW5ncy9ydWxlcyc7XHJcbmV4cG9ydCB2YXIgVElNRVNUQU1QID0ge1wiLnN2XCI6IFwidGltZXN0YW1wXCJ9O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIENsaWVudChhcHBOYW1lLCBzZWNyZXQpIHtcclxuICB0aGlzLmFwcE5hbWUgPSBhcHBOYW1lO1xyXG4gIHRoaXMuc2VjcmV0ID0gc2VjcmV0O1xyXG59XHJcblxyXG51dGlsLm1ldGhvZHMoQ2xpZW50LCB7XHJcbiAgc2V0RGVidWc6IGZ1bmN0aW9uKGRlYnVnKSB7XHJcbiAgICBpZiAoZGVidWcgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBkZWJ1ZyA9IHRydWU7XHJcbiAgICB9XHJcbiAgICB0aGlzLmRlYnVnID0gZGVidWc7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBnZXQ6IGZ1bmN0aW9uKGxvY2F0aW9uKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHttZXRob2Q6ICdHRVQnfSwgbG9jYXRpb24pO1xyXG4gIH0sXHJcblxyXG4gIHB1dDogZnVuY3Rpb24obG9jYXRpb24sIGNvbnRlbnQpIHtcclxuICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe21ldGhvZDogJ1BVVCcsIHByaW50OiAnc2lsZW50J30sIGxvY2F0aW9uLCBjb250ZW50KTtcclxuICB9LFxyXG5cclxuICByZXF1ZXN0OiBmdW5jdGlvbihvcHQsIHBhdGgsIGNvbnRlbnQpIHtcclxuICAgIHZhciBvcHRpb25zID0ge1xyXG4gICAgICBob3N0bmFtZTogdGhpcy5hcHBOYW1lICsgJy4nICsgRklSRUJBU0VfSE9TVCxcclxuICAgICAgcGF0aDogcGF0aCArICcuanNvbicsXHJcbiAgICAgIG1ldGhvZDogb3B0Lm1ldGhvZCxcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHF1ZXJ5OiBhbnkgPSB7fTtcclxuICAgIGlmIChvcHQucHJpbnQpIHtcclxuICAgICAgcXVlcnkucHJpbnQgPSBvcHQucHJpbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgcXVlcnkuYXV0aCA9IHRoaXMuc2VjcmV0O1xyXG5cclxuICAgIGlmIChPYmplY3Qua2V5cyhxdWVyeSkubGVuZ3RoID4gMCkge1xyXG4gICAgICBvcHRpb25zLnBhdGggKz0gJz8nICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHF1ZXJ5KTtcclxuICAgIH1cclxuXHJcbiAgICBjb250ZW50ID0gdXRpbC5wcmV0dHlKU09OKGNvbnRlbnQpO1xyXG5cclxuICAgIHJldHVybiByZXF1ZXN0KG9wdGlvbnMsIGNvbnRlbnQsIHRoaXMuZGVidWcpXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uKGJvZHkpIHtcclxuICAgICAgICByZXR1cm4gYm9keSA9PT0gJycgPyBudWxsIDogSlNPTi5wYXJzZShib2R5KTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG59KTtcclxuXHJcbnZhciByaWROZXh0ID0gMDtcclxuXHJcbmZ1bmN0aW9uIHJlcXVlc3Qob3B0aW9ucywgY29udGVudCwgZGVidWcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJpZE5leHQgKz0gMTtcclxuICB2YXIgcmlkID0gcmlkTmV4dDtcclxuXHJcbiAgZnVuY3Rpb24gbG9nKHMpIHtcclxuICAgIGlmIChkZWJ1Zykge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIlJlcXVlc3Q8XCIgKyByaWQgKyBcIj46IFwiICsgcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsb2coXCJSZXF1ZXN0OiBcIiArIHV0aWwucHJldHR5SlNPTihvcHRpb25zKSk7XHJcbiAgaWYgKGNvbnRlbnQpIHtcclxuICAgIGxvZyhcIkJvZHk6ICdcIiArIGNvbnRlbnQgKyBcIidcIik7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAvLyBUT0RPOiBXaHkgaXNuJ3QgdGhpcyBhcmd1bWVudCB0eXBlZCBhcyBwZXIgaHR0cHMucmVxdWVzdD9cclxuICAgIHZhciByZXEgPSBodHRwcy5yZXF1ZXN0KG9wdGlvbnMsIGZ1bmN0aW9uKHJlczogaHR0cC5DbGllbnRSZXNwb25zZSkge1xyXG4gICAgICB2YXIgY2h1bmtzID0gW107XHJcblxyXG4gICAgICByZXMub24oJ2RhdGEnLCBmdW5jdGlvbihib2R5KSB7XHJcbiAgICAgICAgY2h1bmtzLnB1c2goYm9keSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcmVzLm9uKCdlbmQnLCBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgcmVzdWx0OiBzdHJpbmcgPSBjaHVua3Muam9pbignJyk7XHJcbiAgICAgICAgbG9nKFwiUmVzdWx0IChcIiArIHJlcy5zdGF0dXNDb2RlICsgXCIpOiAnXCIgKyByZXN1bHQgKyBcIidcIik7XHJcbiAgICAgICAgaWYgKE1hdGguZmxvb3IocmVzLnN0YXR1c0NvZGUgLyAxMDApICE9PSAyKSB7XHJcbiAgICAgICAgICBsZXQgbWVzc2FnZSA9IFwiU3RhdHVzID0gXCIgKyByZXMuc3RhdHVzQ29kZSArIFwiIFwiICsgcmVzdWx0O1xyXG4gICAgICAgICAgaWYgKHJlcy5oZWFkZXJzW0RFQlVHX0hFQURFUl0pIHtcclxuICAgICAgICAgICAgbGV0IGZvcm1hdHRlZEhlYWRlciA9IHJlcy5oZWFkZXJzW0RFQlVHX0hFQURFUl0uc3BsaXQoJyAvJykuam9pbignXFxuICAvJyk7XHJcbiAgICAgICAgICAgIGxvZyhmb3JtYXR0ZWRIZWFkZXIpO1xyXG4gICAgICAgICAgICBtZXNzYWdlICs9IFwiXFxuXCIgKyBmb3JtYXR0ZWRIZWFkZXI7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1lc3NhZ2UpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoY29udGVudCkge1xyXG4gICAgICByZXEud3JpdGUoY29udGVudCwgJ3V0ZjgnKTtcclxuICAgIH1cclxuICAgIHJlcS5lbmQoKTtcclxuXHJcbiAgICByZXEub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgICAgbG9nKFwiUmVxdWVzdCBlcnJvcjogXCIgKyBlcnJvcik7XHJcbiAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuLy8gb3B0cyB7IGRlYnVnOiBCb29sZWFuLCBhZG1pbjogQm9vbGVhbiB9XHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVVpZEF1dGhUb2tlbih1c2VybmFtZSkge1xyXG4gIHZhciB1aWQgPSB1dWlkLnY0KCk7XHJcbiAgLy92YXIgY2VydCA9IHJlcXVpcmUoJy4uL3NlcnZpY2VBY2NvdW50Q3JlZGVudGlhbHMuanNvbicpO1xyXG4gIHZhciBmYkNsaWVudCA9IGZpcmViYXNlLmluaXRpYWxpemVBcHAoe1xyXG4gICAgICBkYXRhYmFzZVVSTDogXCJodHRwczovL21haW50ZXN0YXBwLmZpcmViYXNlaW8uY29tL1wiLFxyXG4gICAgICBzZXJ2aWNlQWNjb3VudDogXCIuL3NlcnZpY2VBY2NvdW50Q3JlZGVudGlhbHMuanNvblwiLFxyXG4gICAgICBkYXRhYmFzZUF1dGhWYXJpYWJsZU92ZXJyaWRlOiB7XHJcbiAgICAgICAgdWlkOiB1aWRcclxuICAgICAgfVxyXG4gICAgfSwgdWlkKTtcclxuICAgIGZiQ2xpZW50LnVpZCA9IHVpZDtcclxuICAgcmV0dXJuIGZiQ2xpZW50O1xyXG59XHJcblxyXG4vKipcclxuICogRmFuY3kgSUQgZ2VuZXJhdG9yIHRoYXQgY3JlYXRlcyAyMC1jaGFyYWN0ZXIgc3RyaW5nIGlkZW50aWZpZXJzIHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOlxyXG4gKlxyXG4gKiAxLiBUaGV5J3JlIGJhc2VkIG9uIHRpbWVzdGFtcCBzbyB0aGF0IHRoZXkgc29ydCAqYWZ0ZXIqIGFueSBleGlzdGluZyBpZHMuXHJcbiAqIDIuIFRoZXkgY29udGFpbiA3Mi1iaXRzIG9mIHJhbmRvbSBkYXRhIGFmdGVyIHRoZSB0aW1lc3RhbXAgc28gdGhhdCBJRHMgd29uJ3QgY29sbGlkZSB3aXRoIG90aGVyIGNsaWVudHMnIElEcy5cclxuICogMy4gVGhleSBzb3J0ICpsZXhpY29ncmFwaGljYWxseSogKHNvIHRoZSB0aW1lc3RhbXAgaXMgY29udmVydGVkIHRvIGNoYXJhY3RlcnMgdGhhdCB3aWxsIHNvcnQgcHJvcGVybHkpLlxyXG4gKiA0LiBUaGV5J3JlIG1vbm90b25pY2FsbHkgaW5jcmVhc2luZy4gIEV2ZW4gaWYgeW91IGdlbmVyYXRlIG1vcmUgdGhhbiBvbmUgaW4gdGhlIHNhbWUgdGltZXN0YW1wLCB0aGVcclxuICogICAgbGF0dGVyIG9uZXMgd2lsbCBzb3J0IGFmdGVyIHRoZSBmb3JtZXIgb25lcy4gIFdlIGRvIHRoaXMgYnkgdXNpbmcgdGhlIHByZXZpb3VzIHJhbmRvbSBiaXRzXHJcbiAqICAgIGJ1dCBcImluY3JlbWVudGluZ1wiIHRoZW0gYnkgMSAob25seSBpbiB0aGUgY2FzZSBvZiBhIHRpbWVzdGFtcCBjb2xsaXNpb24pLlxyXG4gKi9cclxuXHJcbi8vIE1vZGVsZWQgYWZ0ZXIgYmFzZTY0IHdlYi1zYWZlIGNoYXJzLCBidXQgb3JkZXJlZCBieSBBU0NJSS5cclxudmFyIFBVU0hfQ0hBUlMgPSAnLTAxMjM0NTY3ODlBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWl9hYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eic7XHJcblxyXG4vLyBUaW1lc3RhbXAgb2YgbGFzdCBwdXNoLCB1c2VkIHRvIHByZXZlbnQgbG9jYWwgY29sbGlzaW9ucyBpZiB5b3UgcHVzaCB0d2ljZSBpbiBvbmUgbXMuXHJcbnZhciBsYXN0UHVzaFRpbWUgPSAwO1xyXG5cclxuLy8gV2UgZ2VuZXJhdGUgNzItYml0cyBvZiByYW5kb21uZXNzIHdoaWNoIGdldCB0dXJuZWQgaW50byAxMiBjaGFyYWN0ZXJzIGFuZCBhcHBlbmRlZCB0byB0aGVcclxuLy8gdGltZXN0YW1wIHRvIHByZXZlbnQgY29sbGlzaW9ucyB3aXRoIG90aGVyIGNsaWVudHMuICBXZSBzdG9yZSB0aGUgbGFzdCBjaGFyYWN0ZXJzIHdlXHJcbi8vIGdlbmVyYXRlZCBiZWNhdXNlIGluIHRoZSBldmVudCBvZiBhIGNvbGxpc2lvbiwgd2UnbGwgdXNlIHRob3NlIHNhbWUgY2hhcmFjdGVycyBleGNlcHRcclxuLy8gXCJpbmNyZW1lbnRlZFwiIGJ5IG9uZS5cclxudmFyIGxhc3RSYW5kQ2hhcnMgPSBbXTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVB1c2hJRCgpOiBzdHJpbmcge1xyXG4gIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuICB2YXIgZHVwbGljYXRlVGltZSA9IChub3cgPT09IGxhc3RQdXNoVGltZSk7XHJcbiAgbGFzdFB1c2hUaW1lID0gbm93O1xyXG5cclxuICB2YXIgdGltZVN0YW1wQ2hhcnMgPSBuZXcgQXJyYXkoOCk7XHJcbiAgZm9yICh2YXIgaSA9IDc7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICB0aW1lU3RhbXBDaGFyc1tpXSA9IFBVU0hfQ0hBUlMuY2hhckF0KG5vdyAlIDY0KTtcclxuICAgIC8vIE5PVEU6IENhbid0IHVzZSA8PCBoZXJlIGJlY2F1c2UgamF2YXNjcmlwdCB3aWxsIGNvbnZlcnQgdG8gaW50IGFuZCBsb3NlIHRoZSB1cHBlciBiaXRzLlxyXG4gICAgbm93ID0gTWF0aC5mbG9vcihub3cgLyA2NCk7XHJcbiAgfVxyXG4gIGlmIChub3cgIT09IDApIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignV2Ugc2hvdWxkIGhhdmUgY29udmVydGVkIHRoZSBlbnRpcmUgdGltZXN0YW1wLicpO1xyXG4gIH1cclxuXHJcbiAgdmFyIGlkID0gdGltZVN0YW1wQ2hhcnMuam9pbignJyk7XHJcblxyXG4gIGlmICghZHVwbGljYXRlVGltZSkge1xyXG4gICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHtcclxuICAgICAgbGFzdFJhbmRDaGFyc1tpXSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDY0KTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgLy8gSWYgdGhlIHRpbWVzdGFtcCBoYXNuJ3QgY2hhbmdlZCBzaW5jZSBsYXN0IHB1c2gsIHVzZSB0aGUgc2FtZSByYW5kb20gbnVtYmVyLCBleGNlcHQgaW5jcmVtZW50ZWQgYnkgMS5cclxuICAgIGZvciAoaSA9IDExOyBpID49IDAgJiYgbGFzdFJhbmRDaGFyc1tpXSA9PT0gNjM7IGktLSkge1xyXG4gICAgICBsYXN0UmFuZENoYXJzW2ldID0gMDtcclxuICAgIH1cclxuICAgIGxhc3RSYW5kQ2hhcnNbaV0rKztcclxuICB9XHJcbiAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHtcclxuICAgIGlkICs9IFBVU0hfQ0hBUlMuY2hhckF0KGxhc3RSYW5kQ2hhcnNbaV0pO1xyXG4gIH1cclxuICBpZiAoaWQubGVuZ3RoICE9PSAyMCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdMZW5ndGggc2hvdWxkIGJlIDIwLicpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGlkO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
