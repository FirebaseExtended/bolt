"use strict";
var Promise = require('promise');
var https = require('https');
var util = require('./util');
var querystring = require('querystring');
var uuid = require('node-uuid');
var firebase = require('firebase');
var FIREBASE_HOST = 'firebaseio.com';
var DEBUG_HEADER = 'x-firebase-auth-debug';
exports.RULES_LOCATION = '/.settings/rules';
exports.TIMESTAMP = { ".sv": "timestamp" };
function Client(appName, secret) {
    this.appName = appName;
    this.secret = secret;
}
exports.Client = Client;
util.methods(Client, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = true;
        }
        this.debug = debug;
        return this;
    },
    get: function (location) {
        return this.request({ method: 'GET' }, location);
    },
    put: function (location, content) {
        return this.request({ method: 'PUT', print: 'silent' }, location, content);
    },
    request: function (opt, path, content) {
        var options = {
            hostname: this.appName + '.' + FIREBASE_HOST,
            path: path + '.json',
            method: opt.method
        };
        var query = {};
        if (opt.print) {
            query.print = opt.print;
        }
        query.auth = this.secret;
        if (Object.keys(query).length > 0) {
            options.path += '?' + querystring.stringify(query);
        }
        content = util.prettyJSON(content);
        return request(options, content, this.debug)
            .then(function (body) {
            return body === '' ? null : JSON.parse(body);
        });
    }
});
var ridNext = 0;
function request(options, content, debug) {
    ridNext += 1;
    var rid = ridNext;
    function log(s) {
        if (debug) {
            console.log("Request<" + rid + ">: " + s);
        }
    }
    log("Request: " + util.prettyJSON(options));
    if (content) {
        log("Body: '" + content + "'");
    }
    return new Promise(function (resolve, reject) {
        var req = https.request(options, function (res) {
            var chunks = [];
            res.on('data', function (body) {
                chunks.push(body);
            });
            res.on('end', function () {
                var result = chunks.join('');
                log("Result (" + res.statusCode + "): '" + result + "'");
                if (Math.floor(res.statusCode / 100) !== 2) {
                    var message = "Status = " + res.statusCode + " " + result;
                    if (res.headers[DEBUG_HEADER]) {
                        var formattedHeader = res.headers[DEBUG_HEADER].split(' /').join('\n  /');
                        log(formattedHeader);
                        message += "\n" + formattedHeader;
                    }
                    reject(new Error(message));
                }
                else {
                    resolve(result);
                }
            });
        });
        if (content) {
            req.write(content, 'utf8');
        }
        req.end();
        req.on('error', function (error) {
            log("Request error: " + error);
            reject(error);
        });
    });
}
function createFirebaseDbRefForUser(username, appName) {
    var uid = uuid.v4();
    var fbClient;
    if (username === 'anon') {
        fbClient = firebase.initializeApp({
            databaseURL: 'https://' + appName + '.firebaseio.com/'
        }, uid);
    }
    else {
        fbClient = firebase.initializeApp({
            databaseURL: 'https://' + appName + '.firebaseio.com/',
            serviceAccount: "./serviceAccountCredentials.json",
            databaseAuthVariableOverride: {
                uid: uid
            }
        }, uid);
    }
    fbClient.uid = uid;
    return fbClient;
}
exports.createFirebaseDbRefForUser = createFirebaseDbRefForUser;

//# sourceMappingURL=data:application/json;base64,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QUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxvQ0FBMkMsUUFBUSxFQUFFLE9BQU87SUFDMUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3BCLElBQUksUUFBUSxDQUFFO0lBQ2QsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDeEIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUU7WUFDakMsV0FBVyxFQUFFLFVBQVUsR0FBRyxPQUFPLEdBQUcsa0JBQWtCO1NBQ3ZELEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBRTtZQUMvQixXQUFXLEVBQUUsVUFBVSxHQUFHLE9BQU8sR0FBRyxrQkFBa0I7WUFDdEQsY0FBYyxFQUFFLGtDQUFrQztZQUNsRCw0QkFBNEIsRUFBRTtnQkFDNUIsR0FBRyxFQUFFLEdBQUc7YUFDVDtTQUNGLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFVixDQUFDO0lBQ0QsUUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUNuQixDQUFDO0FBbkJlLGtDQUEwQiw2QkFtQnpDLENBQUEiLCJmaWxlIjoiZmlyZWJhc2UtcmVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEZpcmViYXNlIGhlbHBlciBmdW5jdGlvbnMgZm9yIFJFU1QgQVBJICh1c2luZyBQcm9taXNlcykuXHJcbiAqXHJcbiAqIENvcHlyaWdodCAyMDE1IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbiAqXHJcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3Mvbm9kZS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvZXM2LXByb21pc2UuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL25vZGUtdXVpZC5kLnRzXCIgLz5cclxuXHJcbi8vIFRPRE86IEZpcmViYXNlIDMuMCB0c2QgdXBncmFkZSwgZG9lc24ndCBhcHBlYXIgdG8gYmUgYW4gaXNzdWUgaGVyZS5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvZmlyZWJhc2UuZC50c1wiIC8+XHJcblxyXG5pbXBvcnQgUHJvbWlzZSA9IHJlcXVpcmUoJ3Byb21pc2UnKTtcclxuaW1wb3J0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKTtcclxuaW1wb3J0IGh0dHAgPSByZXF1aXJlKCdodHRwJyk7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XHJcbmltcG9ydCBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XHJcbmltcG9ydCB1dWlkID0gcmVxdWlyZSgnbm9kZS11dWlkJyk7XHJcblxyXG52YXIgZmlyZWJhc2UgPSByZXF1aXJlKCdmaXJlYmFzZScpO1xyXG5cclxudmFyIEZJUkVCQVNFX0hPU1QgPSAnZmlyZWJhc2Vpby5jb20nO1xyXG52YXIgREVCVUdfSEVBREVSID0gJ3gtZmlyZWJhc2UtYXV0aC1kZWJ1Zyc7XHJcblxyXG5leHBvcnQgdmFyIFJVTEVTX0xPQ0FUSU9OID0gICcvLnNldHRpbmdzL3J1bGVzJztcclxuZXhwb3J0IHZhciBUSU1FU1RBTVAgPSB7XCIuc3ZcIjogXCJ0aW1lc3RhbXBcIn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gQ2xpZW50KGFwcE5hbWUsIHNlY3JldCkge1xyXG4gIHRoaXMuYXBwTmFtZSA9IGFwcE5hbWU7XHJcbiAgdGhpcy5zZWNyZXQgPSBzZWNyZXQ7XHJcbn1cclxuXHJcbnV0aWwubWV0aG9kcyhDbGllbnQsIHtcclxuICBzZXREZWJ1ZzogZnVuY3Rpb24oZGVidWcpIHtcclxuICAgIGlmIChkZWJ1ZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGRlYnVnID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIHRoaXMuZGVidWcgPSBkZWJ1ZztcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGdldDogZnVuY3Rpb24obG9jYXRpb24pIHtcclxuICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe21ldGhvZDogJ0dFVCd9LCBsb2NhdGlvbik7XHJcbiAgfSxcclxuXHJcbiAgcHV0OiBmdW5jdGlvbihsb2NhdGlvbiwgY29udGVudCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCh7bWV0aG9kOiAnUFVUJywgcHJpbnQ6ICdzaWxlbnQnfSwgbG9jYXRpb24sIGNvbnRlbnQpO1xyXG4gIH0sXHJcblxyXG4gIHJlcXVlc3Q6IGZ1bmN0aW9uKG9wdCwgcGF0aCwgY29udGVudCkge1xyXG4gICAgdmFyIG9wdGlvbnMgPSB7XHJcbiAgICAgIGhvc3RuYW1lOiB0aGlzLmFwcE5hbWUgKyAnLicgKyBGSVJFQkFTRV9IT1NULFxyXG4gICAgICBwYXRoOiBwYXRoICsgJy5qc29uJyxcclxuICAgICAgbWV0aG9kOiBvcHQubWV0aG9kLFxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcXVlcnk6IGFueSA9IHt9O1xyXG4gICAgaWYgKG9wdC5wcmludCkge1xyXG4gICAgICBxdWVyeS5wcmludCA9IG9wdC5wcmludDtcclxuICAgIH1cclxuXHJcbiAgICBxdWVyeS5hdXRoID0gdGhpcy5zZWNyZXQ7XHJcblxyXG4gICAgaWYgKE9iamVjdC5rZXlzKHF1ZXJ5KS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIG9wdGlvbnMucGF0aCArPSAnPycgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocXVlcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnRlbnQgPSB1dGlsLnByZXR0eUpTT04oY29udGVudCk7XHJcblxyXG4gICAgcmV0dXJuIHJlcXVlc3Qob3B0aW9ucywgY29udGVudCwgdGhpcy5kZWJ1ZylcclxuICAgICAgLnRoZW4oZnVuY3Rpb24oYm9keSkge1xyXG4gICAgICAgIHJldHVybiBib2R5ID09PSAnJyA/IG51bGwgOiBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICB9KTtcclxuICB9XHJcbn0pO1xyXG5cclxudmFyIHJpZE5leHQgPSAwO1xyXG5cclxuZnVuY3Rpb24gcmVxdWVzdChvcHRpb25zLCBjb250ZW50LCBkZWJ1Zyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmlkTmV4dCArPSAxO1xyXG4gIHZhciByaWQgPSByaWROZXh0O1xyXG5cclxuICBmdW5jdGlvbiBsb2cocykge1xyXG4gICAgaWYgKGRlYnVnKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiUmVxdWVzdDxcIiArIHJpZCArIFwiPjogXCIgKyBzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGxvZyhcIlJlcXVlc3Q6IFwiICsgdXRpbC5wcmV0dHlKU09OKG9wdGlvbnMpKTtcclxuICBpZiAoY29udGVudCkge1xyXG4gICAgbG9nKFwiQm9keTogJ1wiICsgY29udGVudCArIFwiJ1wiKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgIC8vIFRPRE86IFdoeSBpc24ndCB0aGlzIGFyZ3VtZW50IHR5cGVkIGFzIHBlciBodHRwcy5yZXF1ZXN0P1xyXG4gICAgdmFyIHJlcSA9IGh0dHBzLnJlcXVlc3Qob3B0aW9ucywgZnVuY3Rpb24ocmVzOiBodHRwLkNsaWVudFJlc3BvbnNlKSB7XHJcbiAgICAgIHZhciBjaHVua3MgPSBbXTtcclxuXHJcbiAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uKGJvZHkpIHtcclxuICAgICAgICBjaHVua3MucHVzaChib2R5KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciByZXN1bHQ6IHN0cmluZyA9IGNodW5rcy5qb2luKCcnKTtcclxuICAgICAgICBsb2coXCJSZXN1bHQgKFwiICsgcmVzLnN0YXR1c0NvZGUgKyBcIik6ICdcIiArIHJlc3VsdCArIFwiJ1wiKTtcclxuICAgICAgICBpZiAoTWF0aC5mbG9vcihyZXMuc3RhdHVzQ29kZSAvIDEwMCkgIT09IDIpIHtcclxuICAgICAgICAgIGxldCBtZXNzYWdlID0gXCJTdGF0dXMgPSBcIiArIHJlcy5zdGF0dXNDb2RlICsgXCIgXCIgKyByZXN1bHQ7XHJcbiAgICAgICAgICBpZiAocmVzLmhlYWRlcnNbREVCVUdfSEVBREVSXSkge1xyXG4gICAgICAgICAgICBsZXQgZm9ybWF0dGVkSGVhZGVyID0gcmVzLmhlYWRlcnNbREVCVUdfSEVBREVSXS5zcGxpdCgnIC8nKS5qb2luKCdcXG4gIC8nKTtcclxuICAgICAgICAgICAgbG9nKGZvcm1hdHRlZEhlYWRlcik7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgKz0gXCJcXG5cIiArIGZvcm1hdHRlZEhlYWRlcjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IobWVzc2FnZSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChjb250ZW50KSB7XHJcbiAgICAgIHJlcS53cml0ZShjb250ZW50LCAndXRmOCcpO1xyXG4gICAgfVxyXG4gICAgcmVxLmVuZCgpO1xyXG5cclxuICAgIHJlcS5vbignZXJyb3InLCBmdW5jdGlvbihlcnJvcikge1xyXG4gICAgICBsb2coXCJSZXF1ZXN0IGVycm9yOiBcIiArIGVycm9yKTtcclxuICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRmlyZWJhc2VEYlJlZkZvclVzZXIodXNlcm5hbWUsIGFwcE5hbWUpIHtcclxuICB2YXIgdWlkID0gdXVpZC52NCgpO1xyXG4gIHZhciBmYkNsaWVudCA7XHJcbiAgaWYgKHVzZXJuYW1lID09PSAnYW5vbicpIHtcclxuICAgIGZiQ2xpZW50ID0gZmlyZWJhc2UuaW5pdGlhbGl6ZUFwcCgge1xyXG4gICAgICBkYXRhYmFzZVVSTDogJ2h0dHBzOi8vJyArIGFwcE5hbWUgKyAnLmZpcmViYXNlaW8uY29tLydcclxuICAgIH0sIHVpZCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGZiQ2xpZW50ID0gZmlyZWJhc2UuaW5pdGlhbGl6ZUFwcCgge1xyXG4gICAgICAgIGRhdGFiYXNlVVJMOiAnaHR0cHM6Ly8nICsgYXBwTmFtZSArICcuZmlyZWJhc2Vpby5jb20vJyxcclxuICAgICAgICBzZXJ2aWNlQWNjb3VudDogXCIuL3NlcnZpY2VBY2NvdW50Q3JlZGVudGlhbHMuanNvblwiLFxyXG4gICAgICAgIGRhdGFiYXNlQXV0aFZhcmlhYmxlT3ZlcnJpZGU6IHtcclxuICAgICAgICAgIHVpZDogdWlkXHJcbiAgICAgICAgfVxyXG4gICAgICB9LCB1aWQpO1xyXG5cclxuICAgIH1cclxuICAgIGZiQ2xpZW50LnVpZCA9IHVpZDtcclxuICAgcmV0dXJuIGZiQ2xpZW50O1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
