"use strict";
var Promise = require('promise');
var chai = require('chai');
var assert = chai.assert;
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = (typeof window !== 'undefined' && window.bolt) || require('./bolt');
var MAX_TEST_MS = 60000;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
function RulesSuite(suiteName, fnSuite) {
    this.suiteName = suiteName;
    this.fnSuite = fnSuite;
    this.users = {};
    this.tests = [];
    this.debug = false;
}
util.methods(RulesSuite, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = false;
        }
        this.debug = debug;
        return this;
    },
    run: function () {
        var self = this;
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = bolt.generate(util.getProp(fileIO.readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database]).then(self.onRulesReady.bind(self));
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    },
    getInterface: function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    },
    onRulesReady: function (prereq) {
        this.rules = prereq[0];
        return this.adminClient.put(rest.RULES_LOCATION, this.rules);
    },
    runTests: function () {
        var p = Promise.resolve(true);
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    },
    test: function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    },
    rules: function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    },
    database: function (appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appSecret = appSecret;
        this.adminClient = new rest.Client(appSecret.appName, appSecret.secret);
        this.databaseReady();
    },
    uid: function (username) {
        return this.users[username].uid;
    },
    ensureUser: function (username) {
        if (!(username in this.users)) {
            var clientInfo;
            if (username === 'admin') {
                clientInfo = new rest.Client(this.appSecret.appName, this.appSecret.secret);
            }
            else {
                clientInfo = rest.createFirebaseDbRefForUser(username, this.appSecret.appName);
            }
            this.users[username] = clientInfo;
        }
        return this.users[username];
    }
});
function RulesTest(testName, suite, fnTest) {
    this.testName = testName;
    this.suite = suite;
    this.fnTest = fnTest;
    this.status = undefined;
    this.lastError = undefined;
    this.steps = [];
    this.failed = false;
    this.path = undefined;
    this.auth = undefined;
}
util.methods(RulesTest, {
    run: function () {
        var _this = this;
        this.debug(true);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    },
    queue: function (op, args, fn) {
        if (this.failed) {
            return;
        }
        args = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + args.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    },
    executeQueue: function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    },
    debug: function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
        });
        return this;
    },
    as: function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        this.queue('as', arguments, function () {
            _this.client = client;
            _this.username = username;
        });
        return this;
    },
    at: function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
        });
        return this;
    },
    write: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            var tmp;
            if (_this.username === 'admin') {
                tmp = _this.client.put(_this.path, obj)
                    .then(function () {
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            else {
                tmp = _this.client.database().ref(_this.path).set(obj)
                    .then(function () {
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            return tmp;
        });
        return this;
    },
    push: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            return _this.client.database().ref(_this.path).push(obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    read: function () {
        var _this = this;
        this.queue('read', arguments, function () {
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    succeeds: function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    fails: function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    good: function (message) {
        this.log(message + " (Correct)");
    },
    log: function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    },
    messageFormat: function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    }
});

//# sourceMappingURL=data:application/json;base64,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RUFBRSxTQUFTLEVBQUU7WUFDN0IsTUFBTSxDQUFDLEtBQUksQ0FBQyxNQUFNLEtBQUssS0FBSyxFQUNyQixLQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sR0FBRyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7WUFDOUQsS0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNuQixLQUFJLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsSUFBSSxFQUFFLFVBQVMsT0FBTztRQUNwQixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsR0FBRyxFQUFFLFVBQVMsT0FBTztRQUNuQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDM0MsQ0FBQztJQUNILENBQUM7SUFFRCxhQUFhLEVBQUUsVUFBUyxPQUFPO1FBQzdCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDO0lBQ3BFLENBQUM7Q0FDRixDQUFDLENBQUMiLCJmaWxlIjoic2ltdWxhdG9yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogRmlyZWJhc2UgUnVsZXMgdGVzdCBzaW11bGF0b3IuXHJcbiAqXHJcbiAqIENvcHlyaWdodCAyMDE1IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbiAqXHJcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3Mvbm9kZS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvY2hhaS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvbW9jaGEuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL2VzNi1wcm9taXNlLmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IFByb21pc2UgPSByZXF1aXJlKCdwcm9taXNlJyk7XHJcbmltcG9ydCBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xyXG52YXIgYXNzZXJ0ID0gY2hhaS5hc3NlcnQ7XHJcbmltcG9ydCByZXN0ID0gcmVxdWlyZSgnLi9maXJlYmFzZS1yZXN0Jyk7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XHJcbmltcG9ydCBmaWxlSU8gPSByZXF1aXJlKCcuL2ZpbGUtaW8nKTtcclxuXHJcbi8vIEJyb3dzZXJpZnkgYnVnOiBodHRwczovL2dpdGh1Yi5jb20vc3Vic3RhY2svbm9kZS1icm93c2VyaWZ5L2lzc3Vlcy8xMTUwXHJcbmludGVyZmFjZSBXaW5kb3cgeyBib2x0OiBhbnk7IH1cclxuZGVjbGFyZSB2YXIgd2luZG93OiBXaW5kb3c7XHJcbnZhciBib2x0ID0gKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5ib2x0KSB8fCByZXF1aXJlKCcuL2JvbHQnKTtcclxudmFyIE1BWF9URVNUX01TID0gNjAwMDA7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcnVsZXNTdWl0ZShzdWl0ZU5hbWUsIGZuU3VpdGUpIHtcclxuICBuZXcgUnVsZXNTdWl0ZShzdWl0ZU5hbWUsIGZuU3VpdGUpLnJ1bigpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBSdWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkge1xyXG4gIHRoaXMuc3VpdGVOYW1lID0gc3VpdGVOYW1lO1xyXG4gIHRoaXMuZm5TdWl0ZSA9IGZuU3VpdGU7XHJcbiAgdGhpcy51c2VycyA9IHt9O1xyXG4gIHRoaXMudGVzdHMgPSBbXTtcclxuICB0aGlzLmRlYnVnID0gZmFsc2U7XHJcbn1cclxuXHJcbnV0aWwubWV0aG9kcyhSdWxlc1N1aXRlLCB7XHJcbiAgc2V0RGVidWc6IGZ1bmN0aW9uKGRlYnVnKSB7XHJcbiAgICBpZiAoZGVidWcgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBkZWJ1ZyA9IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kZWJ1ZyA9IGRlYnVnO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgcnVuOiBmdW5jdGlvbigpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICAvLyBSdW4gTW9jaGEgVGVzdCBTdWl0ZSAtIHNlcmlhbGl6ZSB3aXRoIGFueSBvdGhlciBtb2NoYSB0ZXN0IHN1aXRlcy5cclxuICAgIHN1aXRlKFwiRmlyZWJhc2UgUnVsZXMgU2ltdWxhdG9yOiBcIiArIHNlbGYuc3VpdGVOYW1lLCBmdW5jdGlvbigpIHtcclxuICAgICAgdGhpcy50aW1lb3V0KE1BWF9URVNUX01TKTtcclxuICAgICAgc3VpdGVTZXR1cChmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgcnVsZXNQYXRoID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xyXG4gICAgICAgICAgc2VsZi5ydWxlc1BhdGhSZXNvbHZlID0gcmVzb2x2ZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIGRhdGFiYXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xyXG4gICAgICAgICAgc2VsZi5kYXRhYmFzZVJlYWR5ID0gcmVzb2x2ZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIHJ1bGVzSlNPTiA9IGJvbHQuZ2VuZXJhdGUodXRpbC5nZXRQcm9wKGZpbGVJTy5yZWFkRmlsZShydWxlc1BhdGgpLCAnY29udGVudCcpKTtcclxuXHJcbiAgICAgICAgLy8gSlQgLSBUT0RPOiBOb3Qgc3VyZSB3aHkgSSBuZWVkZWQgdG8gZGlzYWJsZSB0aGlzLlxyXG4gICAgICAgIHNlbGYucmVhZHkgPSBQcm9taXNlLmFsbChbcnVsZXNKU09OLCBkYXRhYmFzZV0pLnRoZW4oc2VsZi5vblJ1bGVzUmVhZHkuYmluZChzZWxmKSk7XHJcblxyXG4gICAgICAgIC8vIEV4ZWN1dGUgaW5pdGlhbGl6YXRpb24gYW5kIGdldCB0ZXN0IGRlZmluaXRpb25zIChpbiBjbGllbnQgY29kZSkuXHJcbiAgICAgICAgc2VsZi5mblN1aXRlKHNlbGYuZ2V0SW50ZXJmYWNlKCkpO1xyXG5cclxuICAgICAgICByZXR1cm4gc2VsZi5yZWFkeTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiSW5pdGlhbGl6YXRpb24uXCIsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHBhc3NcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiUnVsZXMgdGVzdC5cIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHNlbGYucnVuVGVzdHMoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICAvLyBJbnRlcmZhY2UgZm9yIHRlc3QgZnVuY3Rpb25zOlxyXG4gIC8vICAgdGVzdC5ydWxlcyhydWxlc1BhdGgpXHJcbiAgLy8gICB0ZXN0LmRhdGFiYXNlKGFwcE5hbWUsIGFwcFNlY3JldClcclxuICAvLyAgIHRlc3QudWlkKHVzZXJuYW1lKVxyXG4gIC8vICAgdGVzdCh0ZXN0TmFtZSwgdGVzdEZ1bmN0aW9uKVxyXG4gIC8vICAgdGVzdC5USU1FU1RBTVBcclxuICBnZXRJbnRlcmZhY2U6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHRlc3QgPSB0aGlzLnRlc3QuYmluZCh0aGlzKTtcclxuICAgIHRlc3QucnVsZXMgPSB0aGlzLnJ1bGVzLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LmRhdGFiYXNlID0gdGhpcy5kYXRhYmFzZS5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC51aWQgPSB0aGlzLnVpZC5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC5USU1FU1RBTVAgPSByZXN0LlRJTUVTVEFNUDtcclxuICAgIHJldHVybiB0ZXN0O1xyXG4gIH0sXHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIHJ1bGVzIGFyZSBnZW5lcmF0ZWQgYW5kIHRlc3QgZGF0YWJhc2UgaXMga25vd24uXHJcbiAgLy8gQXJnOiBbcnVsZXNKU09OLCB0cnVlXVxyXG4gIG9uUnVsZXNSZWFkeTogZnVuY3Rpb24ocHJlcmVxKSB7XHJcbiAgICB0aGlzLnJ1bGVzID0gcHJlcmVxWzBdO1xyXG4gICAgcmV0dXJuIHRoaXMuYWRtaW5DbGllbnQucHV0KHJlc3QuUlVMRVNfTE9DQVRJT04sIHRoaXMucnVsZXMpO1xyXG4gIH0sXHJcblxyXG4gIHJ1blRlc3RzOiBmdW5jdGlvbigpIHtcclxuICAgIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xyXG5cclxuICAgIGZ1bmN0aW9uIG5leHQocHJldiwgdGVzdCkge1xyXG4gICAgICByZXR1cm4gcHJldi50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB0ZXN0LnJ1bigpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGVzdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgcCA9IG5leHQocCwgdGhpcy50ZXN0c1tpXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHA7XHJcbiAgfSxcclxuXHJcbiAgdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGZuVGVzdCkge1xyXG4gICAgdGhpcy50ZXN0cy5wdXNoKG5ldyBSdWxlc1Rlc3QodGVzdE5hbWUsIHRoaXMsIGZuVGVzdCkpO1xyXG4gIH0sXHJcblxyXG4gIHJ1bGVzOiBmdW5jdGlvbihydWxlc1BhdGgpIHtcclxuICAgIGlmICh0aGlzLnJ1bGVzUGF0aCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IGV4cGVjdCBhIHNpbmdsZSBjYWxsIHRvIHRoZSB0ZXN0LnJ1bGVzIGZ1bmN0aW9uLlwiKTtcclxuICAgIH1cclxuICAgIHRoaXMucnVsZXNQYXRoID0gcnVsZXNQYXRoO1xyXG4gICAgdGhpcy5ydWxlc1BhdGhSZXNvbHZlKHV0aWwuZW5zdXJlRXh0ZW5zaW9uKHJ1bGVzUGF0aCwgYm9sdC5GSUxFX0VYVEVOU0lPTikpO1xyXG4gIH0sXHJcblxyXG4gIGRhdGFiYXNlOiBmdW5jdGlvbihhcHBTZWNyZXQpIHtcclxuICAgIGlmICh0aGlzLmFkbWluQ2xpZW50KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgZXhwZWN0IGEgc2luZ2xlIGNhbGwgdG8gdGhlIHRlc3QuZGF0YWJhc2UgZnVuY3Rpb24uXCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5hcHBTZWNyZXQgPSBhcHBTZWNyZXQ7XHJcbiAgICB0aGlzLmFkbWluQ2xpZW50ID0gbmV3IHJlc3QuQ2xpZW50KGFwcFNlY3JldC5hcHBOYW1lLCBhcHBTZWNyZXQuc2VjcmV0KTsgLy8gdXNpbmcgY2xhc3NpYyByZXN0IGludGVyZmFjZSBzdGlsbFxyXG4gICAgdGhpcy5kYXRhYmFzZVJlYWR5KCk7XHJcbiAgfSxcclxuXHJcbiAgdWlkOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlcnNbdXNlcm5hbWVdLnVpZDtcclxuICB9LFxyXG5cclxuICBlbnN1cmVVc2VyOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgaWYgKCEodXNlcm5hbWUgaW4gdGhpcy51c2VycykpIHtcclxuICAgICAgICB2YXIgY2xpZW50SW5mbztcclxuICAgICAgICBpZiAodXNlcm5hbWUgPT09ICdhZG1pbicpIHtcclxuICAgICAgICAgIGNsaWVudEluZm8gPSBuZXcgcmVzdC5DbGllbnQodGhpcy5hcHBTZWNyZXQuYXBwTmFtZSwgdGhpcy5hcHBTZWNyZXQuc2VjcmV0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY2xpZW50SW5mbyA9IHJlc3QuY3JlYXRlRmlyZWJhc2VEYlJlZkZvclVzZXIodXNlcm5hbWUsIHRoaXMuYXBwU2VjcmV0LmFwcE5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVzZXJzW3VzZXJuYW1lXSA9IGNsaWVudEluZm87XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy51c2Vyc1t1c2VybmFtZV07XHJcbiAgfVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIFJ1bGVzVGVzdCh0ZXN0TmFtZSwgc3VpdGUsIGZuVGVzdCkge1xyXG4gIHRoaXMudGVzdE5hbWUgPSB0ZXN0TmFtZTtcclxuICB0aGlzLnN1aXRlID0gc3VpdGU7XHJcbiAgdGhpcy5mblRlc3QgPSBmblRlc3Q7XHJcbiAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5sYXN0RXJyb3IgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5zdGVwcyA9IFtdO1xyXG4gIHRoaXMuZmFpbGVkID0gZmFsc2U7XHJcblxyXG4gIC8vIEN1cnJlbnQgdXNlciBhbmQgcGF0aCAoZm9yIHJlYWQvd3JpdGUpLlxyXG4gIHRoaXMucGF0aCA9IHVuZGVmaW5lZDtcclxuICB0aGlzLmF1dGggPSB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbnV0aWwubWV0aG9kcyhSdWxlc1Rlc3QsIHtcclxuICBydW46IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5kZWJ1Zyh0cnVlKTtcclxuXHJcbiAgICB0aGlzLmFzKCdhZG1pbicpO1xyXG4gICAgdGhpcy5hdCgnLycpO1xyXG4gICAgdGhpcy53cml0ZShudWxsKTsgLy8gQ2xlYXIgb3V0IGFueSBleGlzdGluZyBkYXRhXHJcbiAgICB0aGlzLnN1Y2NlZWRzKFwiaW5pdGlhbGl6YXRpb25cIik7XHJcbiAgICB0aGlzLmF0KHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLmFzKCdhbm9uJyk7XHJcbiAgICB0aGlzLmZuVGVzdCh0aGlzKTtcclxuLy8gICAgdGhpcy5kZWJ1ZyhmYWxzZSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZVF1ZXVlKClcclxuICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9nKFwiRmluaXNoZWRcIik7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICB0aGlzLmxvZyhcIkZhaWxlZDogXCIgKyBlcnJvcik7XHJcbiAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgIH0pO1xyXG4gIH0sXHJcblxyXG4gIC8vIFF1ZXVlIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGluIHNlcXVlbmNlIGFmdGVyIHByZXZpb3VzIHN0ZXBcclxuICAvLyBpbiB0ZXN0IGlzIChzdWNjZXNzZnVsbHkpIGNvbXBsZXRlZC5cclxuICBxdWV1ZTogZnVuY3Rpb24ob3AsIGFyZ3MsIGZuKSB7XHJcbiAgICBpZiAodGhpcy5mYWlsZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgYXJncyA9IHV0aWwuY29weUFycmF5KGFyZ3MpLm1hcChmdW5jdGlvbih4KSB7XHJcbiAgICAgIHJldHVybiB1dGlsLnByZXR0eUpTT04oeCk7XHJcbiAgICB9KTtcclxuICAgIHZhciBsYWJlbCA9IG9wICsgJygnICsgYXJncy5qb2luKCcsICcpICsgJyknO1xyXG4gICAgdGhpcy5zdGVwcy5wdXNoKHtsYWJlbDogbGFiZWwsIGZuOiBmbn0pO1xyXG4gIH0sXHJcblxyXG4gIGV4ZWN1dGVRdWV1ZTogZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgdGhpcy5sb2coXCJFeGVjdXRpbmcgKFwiICsgdGhpcy5zdGVwcy5sZW5ndGggKyBcIiBzdGVwcylcIik7XHJcbiAgICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSh0cnVlKTtcclxuXHJcbiAgICBmdW5jdGlvbiBuZXh0KHByZXYsIHN0ZXApIHtcclxuICAgICAgcmV0dXJuIHByZXYudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICBzZWxmLmxvZyhzdGVwLmxhYmVsKTtcclxuICAgICAgICByZXR1cm4gc3RlcC5mbigpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuc3RlcHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgcCA9IG5leHQocCwgdGhpcy5zdGVwc1tpXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHA7XHJcbiAgfSxcclxuXHJcbiAgZGVidWc6IGZ1bmN0aW9uKGRlYnVnKSB7XHJcbiAgICB0aGlzLnN1aXRlLnNldERlYnVnKGRlYnVnKTtcclxuICAgIHRoaXMucXVldWUoJ2RlYnVnJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMuc3VpdGUuc2V0RGVidWcoZGVidWcpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBhczogZnVuY3Rpb24odXNlcm5hbWUpIHtcclxuICAgIHZhciBjbGllbnQgPSB0aGlzLnN1aXRlLmVuc3VyZVVzZXIodXNlcm5hbWUpO1xyXG4gICAgdGhpcy5xdWV1ZSgnYXMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XHJcbiAgICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXQ6IGZ1bmN0aW9uKG9wUGF0aCkge1xyXG4gICAgdGhpcy5xdWV1ZSgnYXQnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5wYXRoID0gb3BQYXRoO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICAvLyBUT0RPOiBDbGVhbnVwLiBUaGVyZSdzIGdvdCB0byBiZSBhIGJldHRlciBhZG1pbiBVSSBmb3IgZG9pbmcgdGhpc1xyXG4gIHdyaXRlOiBmdW5jdGlvbihvYmopIHtcclxuICAgIHRoaXMucXVldWUoJ3dyaXRlJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHZhciB0bXA7XHJcbiAgICAgIGlmICh0aGlzLnVzZXJuYW1lID09PSAnYWRtaW4nKSB7XHJcbiAgICAgICAgdG1wID0gdGhpcy5jbGllbnQucHV0KHRoaXMucGF0aCwgb2JqKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgdG1wID0gdGhpcy5jbGllbnQuZGF0YWJhc2UoKS5yZWYodGhpcy5wYXRoKS5zZXQob2JqKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRtcDtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIHB1c2g6IGZ1bmN0aW9uKG9iaikge1xyXG4gICAgdGhpcy5xdWV1ZSgnd3JpdGUnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRhdGFiYXNlKCkucmVmKHRoaXMucGF0aCkucHVzaChvYmopXHJcbiAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgIH0pXHJcbiAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgcmVhZDogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdyZWFkJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5nZXQodGhpcy5wYXRoKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBzdWNjZWVkczogZnVuY3Rpb24obWVzc2FnZSkge1xyXG4gICAgdGhpcy5xdWV1ZSgnc3VjY2VlZHMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgYXNzZXJ0KHRoaXMuc3RhdHVzID09PSB0cnVlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgc3VjY2VlZClcXG5cIiArIHRoaXMubGFzdEVycm9yKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGZhaWxzOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdmYWlscycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICBhc3NlcnQodGhpcy5zdGF0dXMgPT09IGZhbHNlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgZmFpbGVkKVwiKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGdvb2Q6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHRoaXMubG9nKG1lc3NhZ2UgKyBcIiAoQ29ycmVjdClcIik7XHJcbiAgfSxcclxuXHJcbiAgbG9nOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICBpZiAodGhpcy5zdWl0ZS5kZWJ1Zykge1xyXG4gICAgICBjb25zb2xlLmxvZyh0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSkpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG1lc3NhZ2VGb3JtYXQ6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHJldHVybiB0aGlzLnN1aXRlLnN1aXRlTmFtZSArIFwiLlwiICsgdGhpcy50ZXN0TmFtZSArIFwiIFwiICsgbWVzc2FnZTtcclxuICB9XHJcbn0pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
