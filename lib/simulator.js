"use strict";
var Promise = require('promise');
var chai = require('chai');
var assert = chai.assert;
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = (typeof window !== 'undefined' && window.bolt) || require('./bolt');
var secrets = require('../auth-secrets.json');
var MAX_TEST_MS = 60000;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
function RulesSuite(suiteName, fnSuite) {
    this.suiteName = suiteName;
    this.fnSuite = fnSuite;
    this.users = {};
    this.tests = [];
    this.debug = false;
}
util.methods(RulesSuite, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = true;
        }
        this.debug = debug;
        return this;
    },
    run: function () {
        var self = this;
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = bolt.generate(util.getProp(fileIO.readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database]).then(self.onRulesReady.bind(self));
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    },
    getInterface: function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    },
    onRulesReady: function (prereq) {
        this.rules = prereq[0];
        console.log(rest.RULES_LOCATION);
        return this.adminClient.put(rest.RULES_LOCATION, this.rules);
    },
    runTests: function () {
        var p = Promise.resolve(true);
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    },
    test: function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    },
    rules: function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    },
    database: function (appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appSecret = appSecret;
        this.adminClient = new rest.Client(secrets.appName, secrets.secret);
        this.databaseReady();
    },
    uid: function (username) {
        console.log('Returning UID: ' + username);
        return this.users[username].uid;
    },
    ensureUser: function (username) {
        if (!(username in this.users)) {
            console.log('Creating User: ' + username);
            var clientInfo;
            if (username === 'admin') {
                clientInfo = new rest.Client(secrets.appName, secrets.secret);
            }
            else {
                clientInfo = rest.generateUidAuthToken(username);
            }
            this.users[username] = clientInfo;
        }
        else {
            console.log('User exists: ' + username);
        }
        return this.users[username];
    }
});
function RulesTest(testName, suite, fnTest) {
    this.testName = testName;
    this.suite = suite;
    this.fnTest = fnTest;
    this.status = undefined;
    this.lastError = undefined;
    this.steps = [];
    this.failed = false;
    this.path = undefined;
    this.auth = undefined;
}
util.methods(RulesTest, {
    run: function () {
        var _this = this;
        this.debug(true);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        this.debug(false);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    },
    queue: function (op, args, fn) {
        if (this.failed) {
            return;
        }
        args = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + args.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    },
    executeQueue: function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                console.log(step.label);
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    },
    debug: function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
        });
        return this;
    },
    as: function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        console.log('##### Ensure User:' + username);
        this.queue('as', arguments, function () {
            _this.client = client;
            _this.username = username;
        });
        return this;
    },
    at: function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
        });
        return this;
    },
    write: function (obj) {
        var _this = this;
        var self = this;
        this.queue('write', arguments, function () {
            var tmp;
            if (_this.username === 'admin') {
                console.log(_this);
                tmp = _this.client.put(_this.path, obj)
                    .then(function () {
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            else {
                tmp = _this.client.database().ref(_this.path).set(obj)
                    .then(function () {
                    console.log('!!!!!!!! Write Success');
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            return tmp;
        });
        return this;
    },
    push: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            var path = _this.path;
            if (path.slice(-1)[0] !== '/') {
                path += '/';
            }
            path += rest.generatePushID();
            return _this.client.put(path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    read: function () {
        var _this = this;
        this.queue('read', arguments, function () {
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    succeeds: function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    fails: function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    good: function (message) {
        this.log(message + " (Correct)");
    },
    log: function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    },
    messageFormat: function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    }
});

//# sourceMappingURL=data:application/json;base64,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LElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxJQUFJLEVBQUUsVUFBUyxPQUFPO1FBQ3BCLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxHQUFHLEVBQUUsVUFBUyxPQUFPO1FBQ25CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQyxDQUFDO0lBQ0gsQ0FBQztJQUVELGFBQWEsRUFBRSxVQUFTLE9BQU87UUFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsR0FBRyxPQUFPLENBQUM7SUFDcEUsQ0FBQztDQUNGLENBQUMsQ0FBQyIsImZpbGUiOiJzaW11bGF0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBGaXJlYmFzZSBSdWxlcyB0ZXN0IHNpbXVsYXRvci5cclxuICpcclxuICogQ29weXJpZ2h0IDIwMTUgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICpcclxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuICpcclxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG4gKlxyXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXHJcbiAqL1xyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9ub2RlLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9jaGFpLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9tb2NoYS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvZXM2LXByb21pc2UuZC50c1wiIC8+XHJcblxyXG5pbXBvcnQgUHJvbWlzZSA9IHJlcXVpcmUoJ3Byb21pc2UnKTtcclxuaW1wb3J0IGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XHJcbnZhciBhc3NlcnQgPSBjaGFpLmFzc2VydDtcclxuaW1wb3J0IHJlc3QgPSByZXF1aXJlKCcuL2ZpcmViYXNlLXJlc3QnKTtcclxuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTtcclxuaW1wb3J0IGZpbGVJTyA9IHJlcXVpcmUoJy4vZmlsZS1pbycpO1xyXG5pbXBvcnQgZmlyZWJhc2UgPSByZXF1aXJlKCdmaXJlYmFzZScpO1xyXG5cclxuLy8gQnJvd3NlcmlmeSBidWc6IGh0dHBzOi8vZ2l0aHViLmNvbS9zdWJzdGFjay9ub2RlLWJyb3dzZXJpZnkvaXNzdWVzLzExNTBcclxuaW50ZXJmYWNlIFdpbmRvdyB7IGJvbHQ6IGFueTsgfVxyXG5kZWNsYXJlIHZhciB3aW5kb3c6IFdpbmRvdztcclxudmFyIGJvbHQgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmJvbHQpIHx8IHJlcXVpcmUoJy4vYm9sdCcpO1xyXG52YXIgc2VjcmV0cyA9IHJlcXVpcmUoJy4uL2F1dGgtc2VjcmV0cy5qc29uJyk7XHJcbnZhciBNQVhfVEVTVF9NUyA9IDYwMDAwO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJ1bGVzU3VpdGUoc3VpdGVOYW1lLCBmblN1aXRlKSB7XHJcbiAgbmV3IFJ1bGVzU3VpdGUoc3VpdGVOYW1lLCBmblN1aXRlKS5ydW4oKTtcclxufVxyXG5cclxuZnVuY3Rpb24gUnVsZXNTdWl0ZShzdWl0ZU5hbWUsIGZuU3VpdGUpIHtcclxuICB0aGlzLnN1aXRlTmFtZSA9IHN1aXRlTmFtZTtcclxuICB0aGlzLmZuU3VpdGUgPSBmblN1aXRlO1xyXG4gIHRoaXMudXNlcnMgPSB7fTtcclxuICB0aGlzLnRlc3RzID0gW107XHJcbiAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xyXG59XHJcblxyXG51dGlsLm1ldGhvZHMoUnVsZXNTdWl0ZSwge1xyXG4gIHNldERlYnVnOiBmdW5jdGlvbihkZWJ1Zykge1xyXG4gICAgaWYgKGRlYnVnID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgZGVidWcgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kZWJ1ZyA9IGRlYnVnO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgcnVuOiBmdW5jdGlvbigpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICAvLyBSdW4gTW9jaGEgVGVzdCBTdWl0ZSAtIHNlcmlhbGl6ZSB3aXRoIGFueSBvdGhlciBtb2NoYSB0ZXN0IHN1aXRlcy5cclxuICAgIHN1aXRlKFwiRmlyZWJhc2UgUnVsZXMgU2ltdWxhdG9yOiBcIiArIHNlbGYuc3VpdGVOYW1lLCBmdW5jdGlvbigpIHtcclxuICAgICAgdGhpcy50aW1lb3V0KE1BWF9URVNUX01TKTtcclxuICAgICAgc3VpdGVTZXR1cChmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgcnVsZXNQYXRoID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xyXG4gICAgICAgICAgc2VsZi5ydWxlc1BhdGhSZXNvbHZlID0gcmVzb2x2ZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIGRhdGFiYXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xyXG4gICAgICAgICAgc2VsZi5kYXRhYmFzZVJlYWR5ID0gcmVzb2x2ZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIHJ1bGVzSlNPTiA9IGJvbHQuZ2VuZXJhdGUodXRpbC5nZXRQcm9wKGZpbGVJTy5yZWFkRmlsZShydWxlc1BhdGgpLCAnY29udGVudCcpKTtcclxuXHJcbiAgICAgICAgLy8gSlQgLSBUT0RPOiBOb3Qgc3VyZSB3aHkgSSBuZWVkZWQgdG8gZGlzYWJsZSB0aGlzLlxyXG4gICAgICAgIHNlbGYucmVhZHkgPSBQcm9taXNlLmFsbChbcnVsZXNKU09OLCBkYXRhYmFzZV0pLnRoZW4oc2VsZi5vblJ1bGVzUmVhZHkuYmluZChzZWxmKSk7XHJcblxyXG4gICAgICAgIC8vIEV4ZWN1dGUgaW5pdGlhbGl6YXRpb24gYW5kIGdldCB0ZXN0IGRlZmluaXRpb25zIChpbiBjbGllbnQgY29kZSkuXHJcbiAgICAgICAgc2VsZi5mblN1aXRlKHNlbGYuZ2V0SW50ZXJmYWNlKCkpO1xyXG5cclxuICAgICAgICByZXR1cm4gc2VsZi5yZWFkeTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiSW5pdGlhbGl6YXRpb24uXCIsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHBhc3NcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiUnVsZXMgdGVzdC5cIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHNlbGYucnVuVGVzdHMoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICAvLyBJbnRlcmZhY2UgZm9yIHRlc3QgZnVuY3Rpb25zOlxyXG4gIC8vICAgdGVzdC5ydWxlcyhydWxlc1BhdGgpXHJcbiAgLy8gICB0ZXN0LmRhdGFiYXNlKGFwcE5hbWUsIGFwcFNlY3JldClcclxuICAvLyAgIHRlc3QudWlkKHVzZXJuYW1lKVxyXG4gIC8vICAgdGVzdCh0ZXN0TmFtZSwgdGVzdEZ1bmN0aW9uKVxyXG4gIC8vICAgdGVzdC5USU1FU1RBTVBcclxuICBnZXRJbnRlcmZhY2U6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHRlc3QgPSB0aGlzLnRlc3QuYmluZCh0aGlzKTtcclxuICAgIHRlc3QucnVsZXMgPSB0aGlzLnJ1bGVzLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LmRhdGFiYXNlID0gdGhpcy5kYXRhYmFzZS5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC51aWQgPSB0aGlzLnVpZC5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC5USU1FU1RBTVAgPSByZXN0LlRJTUVTVEFNUDtcclxuICAgIHJldHVybiB0ZXN0O1xyXG4gIH0sXHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIHJ1bGVzIGFyZSBnZW5lcmF0ZWQgYW5kIHRlc3QgZGF0YWJhc2UgaXMga25vd24uXHJcbiAgLy8gQXJnOiBbcnVsZXNKU09OLCB0cnVlXVxyXG4gIG9uUnVsZXNSZWFkeTogZnVuY3Rpb24ocHJlcmVxKSB7XHJcbiAgICB0aGlzLnJ1bGVzID0gcHJlcmVxWzBdO1xyXG4gICAgY29uc29sZS5sb2cocmVzdC5SVUxFU19MT0NBVElPTik7XHJcbiAgICByZXR1cm4gdGhpcy5hZG1pbkNsaWVudC5wdXQocmVzdC5SVUxFU19MT0NBVElPTiwgdGhpcy5ydWxlcyk7XHJcbiAgfSxcclxuXHJcbiAgcnVuVGVzdHM6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2LCB0ZXN0KSB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRlc3QucnVuKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBwID0gbmV4dChwLCB0aGlzLnRlc3RzW2ldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcDtcclxuICB9LFxyXG5cclxuICB0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZm5UZXN0KSB7XHJcbiAgICB0aGlzLnRlc3RzLnB1c2gobmV3IFJ1bGVzVGVzdCh0ZXN0TmFtZSwgdGhpcywgZm5UZXN0KSk7XHJcbiAgfSxcclxuXHJcbiAgcnVsZXM6IGZ1bmN0aW9uKHJ1bGVzUGF0aCkge1xyXG5cclxuXHJcbiAgICBpZiAodGhpcy5ydWxlc1BhdGgpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5ydWxlcyBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJ1bGVzUGF0aCA9IHJ1bGVzUGF0aDtcclxuICAgIHRoaXMucnVsZXNQYXRoUmVzb2x2ZSh1dGlsLmVuc3VyZUV4dGVuc2lvbihydWxlc1BhdGgsIGJvbHQuRklMRV9FWFRFTlNJT04pKTtcclxuICB9LFxyXG5cclxuICBkYXRhYmFzZTogZnVuY3Rpb24oYXBwU2VjcmV0KSB7XHJcbiAgICBpZiAodGhpcy5hZG1pbkNsaWVudCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IGV4cGVjdCBhIHNpbmdsZSBjYWxsIHRvIHRoZSB0ZXN0LmRhdGFiYXNlIGZ1bmN0aW9uLlwiKTtcclxuICAgIH1cclxuICAgIHRoaXMuYXBwU2VjcmV0ID0gYXBwU2VjcmV0O1xyXG4gICAgdGhpcy5hZG1pbkNsaWVudCA9IG5ldyByZXN0LkNsaWVudChzZWNyZXRzLmFwcE5hbWUsc2VjcmV0cy5zZWNyZXQpOyAvLyB1c2luZyBjbGFzc2ljIHJlc3QgaW50ZXJmYWNlIHN0aWxsXHJcbiAgICB0aGlzLmRhdGFiYXNlUmVhZHkoKTtcclxuICB9LFxyXG5cclxuICB1aWQ6IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XHJcbiAgICBjb25zb2xlLmxvZygnUmV0dXJuaW5nIFVJRDogJyArIHVzZXJuYW1lKTtcclxuICAgIHJldHVybiB0aGlzLnVzZXJzW3VzZXJuYW1lXS51aWQ7XHJcbiAgfSxcclxuXHJcbiAgZW5zdXJlVXNlcjogZnVuY3Rpb24odXNlcm5hbWUpIHtcclxuICAgIGlmICghKHVzZXJuYW1lIGluIHRoaXMudXNlcnMpKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0NyZWF0aW5nIFVzZXI6ICcgKyB1c2VybmFtZSk7XHJcbiAgICAgICAgdmFyIGNsaWVudEluZm9cclxuICAgICAgICBpZih1c2VybmFtZSA9PT0gJ2FkbWluJyl7XHJcbiAgICAgICAgICAgIGNsaWVudEluZm8gPSBuZXcgcmVzdC5DbGllbnQoc2VjcmV0cy5hcHBOYW1lLCBzZWNyZXRzLnNlY3JldCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNsaWVudEluZm8gPSByZXN0LmdlbmVyYXRlVWlkQXV0aFRva2VuKHVzZXJuYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy51c2Vyc1t1c2VybmFtZV0gPSBjbGllbnRJbmZvO1xyXG4gICAgfSBlbHNle1xyXG4gICAgICBjb25zb2xlLmxvZygnVXNlciBleGlzdHM6ICcgKyB1c2VybmFtZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy51c2Vyc1t1c2VybmFtZV07XHJcbiAgfVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIFJ1bGVzVGVzdCh0ZXN0TmFtZSwgc3VpdGUsIGZuVGVzdCkge1xyXG4gIHRoaXMudGVzdE5hbWUgPSB0ZXN0TmFtZTtcclxuICB0aGlzLnN1aXRlID0gc3VpdGU7XHJcbiAgdGhpcy5mblRlc3QgPSBmblRlc3Q7XHJcbiAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5sYXN0RXJyb3IgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5zdGVwcyA9IFtdO1xyXG4gIHRoaXMuZmFpbGVkID0gZmFsc2U7XHJcblxyXG4gIC8vIEN1cnJlbnQgdXNlciBhbmQgcGF0aCAoZm9yIHJlYWQvd3JpdGUpLlxyXG4gIHRoaXMucGF0aCA9IHVuZGVmaW5lZDtcclxuICB0aGlzLmF1dGggPSB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbnV0aWwubWV0aG9kcyhSdWxlc1Rlc3QsIHtcclxuICBydW46IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5kZWJ1Zyh0cnVlKTtcclxuICAgIC8vIEpUOiBUaGlzIGlzIG5vdCB3b3JraW5nIHByb3Blcmx5IGJlbG93XHJcbiAgICB0aGlzLmFzKCdhZG1pbicpO1xyXG4gICAgdGhpcy5hdCgnLycpO1xyXG4gICAgdGhpcy53cml0ZShudWxsKTsgLy8gQ2xlYXIgb3V0IGFueSBleGlzdGluZyBkYXRhXHJcbiAgICB0aGlzLnN1Y2NlZWRzKFwiaW5pdGlhbGl6YXRpb25cIik7XHJcbiAgICB0aGlzLmF0KHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLmFzKCdhbm9uJyk7XHJcbiAgICB0aGlzLmZuVGVzdCh0aGlzKTtcclxuICAgIHRoaXMuZGVidWcoZmFsc2UpO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVRdWV1ZSgpXHJcbiAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvZyhcIkZpbmlzaGVkXCIpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJGYWlsZWQ6IFwiICsgZXJyb3IpO1xyXG4gICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICAvLyBRdWV1ZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpbiBzZXF1ZW5jZSBhZnRlciBwcmV2aW91cyBzdGVwXHJcbiAgLy8gaW4gdGVzdCBpcyAoc3VjY2Vzc2Z1bGx5KSBjb21wbGV0ZWQuXHJcbiAgcXVldWU6IGZ1bmN0aW9uKG9wLCBhcmdzLCBmbikge1xyXG4gICAgaWYgKHRoaXMuZmFpbGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGFyZ3MgPSB1dGlsLmNvcHlBcnJheShhcmdzKS5tYXAoZnVuY3Rpb24oeCkge1xyXG4gICAgICByZXR1cm4gdXRpbC5wcmV0dHlKU09OKHgpO1xyXG4gICAgfSk7XHJcbiAgICB2YXIgbGFiZWwgPSBvcCArICcoJyArIGFyZ3Muam9pbignLCAnKSArICcpJztcclxuICAgIHRoaXMuc3RlcHMucHVzaCh7bGFiZWw6IGxhYmVsLCBmbjogZm59KTtcclxuICB9LFxyXG5cclxuICBleGVjdXRlUXVldWU6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHRoaXMubG9nKFwiRXhlY3V0aW5nIChcIiArIHRoaXMuc3RlcHMubGVuZ3RoICsgXCIgc3RlcHMpXCIpO1xyXG4gICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2LCBzdGVwKSB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coc3RlcC5sYWJlbCk7XHJcbiAgICAgICAgc2VsZi5sb2coc3RlcC5sYWJlbCk7XHJcbiAgICAgICAgcmV0dXJuIHN0ZXAuZm4oKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnN0ZXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIHAgPSBuZXh0KHAsIHRoaXMuc3RlcHNbaV0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwO1xyXG4gIH0sXHJcblxyXG4gIGRlYnVnOiBmdW5jdGlvbihkZWJ1Zykge1xyXG4gICAgdGhpcy5zdWl0ZS5zZXREZWJ1ZyhkZWJ1Zyk7XHJcbiAgICB0aGlzLnF1ZXVlKCdkZWJ1ZycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICB0aGlzLnN1aXRlLnNldERlYnVnKGRlYnVnKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXM6IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XHJcbiAgICB2YXIgY2xpZW50ID0gdGhpcy5zdWl0ZS5lbnN1cmVVc2VyKHVzZXJuYW1lKTtcclxuICAgIGNvbnNvbGUubG9nKCcjIyMjIyBFbnN1cmUgVXNlcjonICsgdXNlcm5hbWUpO1xyXG4gICAgdGhpcy5xdWV1ZSgnYXMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XHJcbiAgICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXQ6IGZ1bmN0aW9uKG9wUGF0aCkge1xyXG4gICAgdGhpcy5xdWV1ZSgnYXQnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5wYXRoID0gb3BQYXRoO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG4vLyBUT0RPOiBDbGVhbnVwLiBUaGVyZSdzIGdvdCB0byBiZSBhIGJldHRlciBhZG1pbiBVSSBmb3IgZG9pbmcgdGhpc1xyXG4gIHdyaXRlOiBmdW5jdGlvbihvYmopIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICB2YXIgdG1wO1xyXG4gICAgICBpZih0aGlzLnVzZXJuYW1lID09PSAnYWRtaW4nKXtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzKTtcclxuICAgICAgICB0bXAgPSB0aGlzLmNsaWVudC5wdXQodGhpcy5wYXRoLCBvYmopXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZXtcclxuICAgICAgIHRtcCA9IHRoaXMuY2xpZW50LmRhdGFiYXNlKCkucmVmKHRoaXMucGF0aCkuc2V0KG9iailcclxuICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnISEhISEhISEgV3JpdGUgU3VjY2VzcycpO1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgICByZXR1cm4gdG1wO1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcbi8vIFRPRE86IFJlLXdyaXRlIHRoaXMgb3ZlciB0byB0aGUgY2xpZW50IGFwaVxyXG4gIHB1c2g6IGZ1bmN0aW9uKG9iaikge1xyXG4gICAgdGhpcy5xdWV1ZSgnd3JpdGUnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgbGV0IHBhdGggPSB0aGlzLnBhdGg7XHJcbiAgICAgIGlmIChwYXRoLnNsaWNlKC0xKVswXSAhPT0gJy8nKSB7XHJcbiAgICAgICAgcGF0aCArPSAnLyc7XHJcbiAgICAgIH1cclxuICAgICAgcGF0aCArPSByZXN0LmdlbmVyYXRlUHVzaElEKCk7XHJcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5wdXQocGF0aCwgb2JqKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICByZWFkOiBmdW5jdGlvbigpIHtcclxuICAgIHRoaXMucXVldWUoJ3JlYWQnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmdldCh0aGlzLnBhdGgpXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIHN1Y2NlZWRzOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdzdWNjZWVkcycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICBhc3NlcnQodGhpcy5zdGF0dXMgPT09IHRydWUsXHJcbiAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSArIFwiIChzaG91bGQgaGF2ZSBzdWNjZWVkKVxcblwiICsgdGhpcy5sYXN0RXJyb3IpKTtcclxuICAgICAgdGhpcy5nb29kKG1lc3NhZ2UpO1xyXG4gICAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgZmFpbHM6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHRoaXMucXVldWUoJ2ZhaWxzJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGFzc2VydCh0aGlzLnN0YXR1cyA9PT0gZmFsc2UsXHJcbiAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSArIFwiIChzaG91bGQgaGF2ZSBmYWlsZWQpXCIpKTtcclxuICAgICAgdGhpcy5nb29kKG1lc3NhZ2UpO1xyXG4gICAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgZ29vZDogZnVuY3Rpb24obWVzc2FnZSkge1xyXG4gICAgdGhpcy5sb2cobWVzc2FnZSArIFwiIChDb3JyZWN0KVwiKTtcclxuICB9LFxyXG5cclxuICBsb2c6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIGlmICh0aGlzLnN1aXRlLmRlYnVnKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMubWVzc2FnZUZvcm1hdChtZXNzYWdlKSk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgbWVzc2FnZUZvcm1hdDogZnVuY3Rpb24obWVzc2FnZSkge1xyXG4gICAgcmV0dXJuIHRoaXMuc3VpdGUuc3VpdGVOYW1lICsgXCIuXCIgKyB0aGlzLnRlc3ROYW1lICsgXCIgXCIgKyBtZXNzYWdlO1xyXG4gIH1cclxufSk7XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
