"use strict";
var Promise = require('promise');
var chai = require('chai');
var assert = chai.assert;
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = (typeof window !== 'undefined' && window.bolt) || require('./bolt');
var MAX_TEST_MS = 60000;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
function RulesSuite(suiteName, fnSuite) {
    this.suiteName = suiteName;
    this.fnSuite = fnSuite;
    this.users = {};
    this.tests = [];
    this.debug = false;
}
util.methods(RulesSuite, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = true;
        }
        this.debug = debug;
        return this;
    },
    run: function () {
        var self = this;
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = bolt.generate(util.getProp(fileIO.readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database])
                    .then(self.onRulesReady.bind(self));
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    },
    getInterface: function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    },
    onRulesReady: function (prereq) {
        this.rules = prereq[0];
        return this.adminClient.put(rest.RULES_LOCATION, this.rules);
    },
    runTests: function () {
        var p = Promise.resolve(true);
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    },
    test: function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    },
    rules: function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    },
    database: function (appName, appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appName = appName;
        this.appSecret = appSecret;
        this.adminClient = this.ensureUser('admin');
        this.databaseReady();
    },
    uid: function (username) {
        return this.ensureUser(username).uid;
    },
    ensureUser: function (username) {
        if (!(username in this.users)) {
            if (username === 'anon') {
                this.users[username] = new rest.Client(this.appName);
            }
            else {
                var tokenInfo;
                tokenInfo = rest.generateUidAuthToken(this.appSecret, { debug: true,
                    admin: username === 'admin' });
                this.users[username] = new rest.Client(this.appName, tokenInfo.token, tokenInfo.uid);
            }
        }
        return this.users[username];
    }
});
function RulesTest(testName, suite, fnTest) {
    this.testName = testName;
    this.suite = suite;
    this.fnTest = fnTest;
    this.status = undefined;
    this.lastError = undefined;
    this.steps = [];
    this.failed = false;
    this.path = undefined;
    this.auth = undefined;
}
util.methods(RulesTest, {
    run: function () {
        var _this = this;
        this.debug(false);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        this.debug(false);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    },
    queue: function (op, args, fn) {
        if (this.failed) {
            return;
        }
        args = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + args.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    },
    executeQueue: function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    },
    debug: function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
        });
        return this;
    },
    as: function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        this.queue('as', arguments, function () {
            _this.client = client;
        });
        return this;
    },
    at: function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
        });
        return this;
    },
    write: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            return _this.client.put(_this.path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    push: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            var path = _this.path;
            if (path.slice(-1)[0] !== '/') {
                path += '/';
            }
            path += rest.generatePushID();
            return _this.client.put(path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    read: function () {
        var _this = this;
        this.queue('read', arguments, function () {
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    succeeds: function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    fails: function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    good: function (message) {
        this.log(message + " (Correct)");
    },
    log: function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    },
    messageFormat: function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    }
});

//# sourceMappingURL=data:application/json;base64,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QUFDLENBQUM7WUFDbkIsS0FBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksRUFBRSxVQUFTLE9BQU87UUFDcEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELEdBQUcsRUFBRSxVQUFTLE9BQU87UUFDbkIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzNDLENBQUM7SUFDSCxDQUFDO0lBRUQsYUFBYSxFQUFFLFVBQVMsT0FBTztRQUM3QixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQztJQUNwRSxDQUFDO0NBQ0YsQ0FBQyxDQUFDIiwiZmlsZSI6InNpbXVsYXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEZpcmViYXNlIFJ1bGVzIHRlc3Qgc2ltdWxhdG9yLlxyXG4gKlxyXG4gKiBDb3B5cmlnaHQgMjAxNSBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxyXG4gKlxyXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG4gKlxyXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcbiAqXHJcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxuICovXHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL25vZGUuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL2NoYWkuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL21vY2hhLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9lczYtcHJvbWlzZS5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCBQcm9taXNlID0gcmVxdWlyZSgncHJvbWlzZScpO1xyXG5pbXBvcnQgY2hhaSA9IHJlcXVpcmUoJ2NoYWknKTtcclxudmFyIGFzc2VydCA9IGNoYWkuYXNzZXJ0O1xyXG5pbXBvcnQgcmVzdCA9IHJlcXVpcmUoJy4vZmlyZWJhc2UtcmVzdCcpO1xyXG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpO1xyXG5pbXBvcnQgZmlsZUlPID0gcmVxdWlyZSgnLi9maWxlLWlvJyk7XHJcblxyXG4vLyBCcm93c2VyaWZ5IGJ1ZzogaHR0cHM6Ly9naXRodWIuY29tL3N1YnN0YWNrL25vZGUtYnJvd3NlcmlmeS9pc3N1ZXMvMTE1MFxyXG5pbnRlcmZhY2UgV2luZG93IHsgYm9sdDogYW55OyB9XHJcbmRlY2xhcmUgdmFyIHdpbmRvdzogV2luZG93O1xyXG52YXIgYm9sdCA9ICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYm9sdCkgfHwgcmVxdWlyZSgnLi9ib2x0Jyk7XHJcblxyXG52YXIgTUFYX1RFU1RfTVMgPSA2MDAwMDtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBydWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkge1xyXG4gIG5ldyBSdWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkucnVuKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIFJ1bGVzU3VpdGUoc3VpdGVOYW1lLCBmblN1aXRlKSB7XHJcbiAgdGhpcy5zdWl0ZU5hbWUgPSBzdWl0ZU5hbWU7XHJcbiAgdGhpcy5mblN1aXRlID0gZm5TdWl0ZTtcclxuICB0aGlzLnVzZXJzID0ge307XHJcbiAgdGhpcy50ZXN0cyA9IFtdO1xyXG4gIHRoaXMuZGVidWcgPSBmYWxzZTtcclxufVxyXG5cclxudXRpbC5tZXRob2RzKFJ1bGVzU3VpdGUsIHtcclxuICBzZXREZWJ1ZzogZnVuY3Rpb24oZGVidWcpIHtcclxuICAgIGlmIChkZWJ1ZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGRlYnVnID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIHRoaXMuZGVidWcgPSBkZWJ1ZztcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIHJ1bjogZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgLy8gUnVuIE1vY2hhIFRlc3QgU3VpdGUgLSBzZXJpYWxpemUgd2l0aCBhbnkgb3RoZXIgbW9jaGEgdGVzdCBzdWl0ZXMuXHJcbiAgICBzdWl0ZShcIkZpcmViYXNlIFJ1bGVzIFNpbXVsYXRvcjogXCIgKyBzZWxmLnN1aXRlTmFtZSwgZnVuY3Rpb24oKSB7XHJcbiAgICAgIHRoaXMudGltZW91dChNQVhfVEVTVF9NUyk7XHJcbiAgICAgIHN1aXRlU2V0dXAoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHJ1bGVzUGF0aCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHtcclxuICAgICAgICAgIHNlbGYucnVsZXNQYXRoUmVzb2x2ZSA9IHJlc29sdmU7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHZhciBkYXRhYmFzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHtcclxuICAgICAgICAgIHNlbGYuZGF0YWJhc2VSZWFkeSA9IHJlc29sdmU7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHZhciBydWxlc0pTT04gPSBib2x0LmdlbmVyYXRlKHV0aWwuZ2V0UHJvcChmaWxlSU8ucmVhZEZpbGUocnVsZXNQYXRoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbnRlbnQnKSk7XHJcblxyXG4gICAgICAgIHNlbGYucmVhZHkgPSBQcm9taXNlLmFsbChbcnVsZXNKU09OLCBkYXRhYmFzZV0pXHJcbiAgICAgICAgICAudGhlbihzZWxmLm9uUnVsZXNSZWFkeS5iaW5kKHNlbGYpKTtcclxuXHJcbiAgICAgICAgLy8gRXhlY3V0ZSBpbml0aWFsaXphdGlvbiBhbmQgZ2V0IHRlc3QgZGVmaW5pdGlvbnMgKGluIGNsaWVudCBjb2RlKS5cclxuICAgICAgICBzZWxmLmZuU3VpdGUoc2VsZi5nZXRJbnRlcmZhY2UoKSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzZWxmLnJlYWR5O1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRlc3QoXCJJbml0aWFsaXphdGlvbi5cIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgLy8gcGFzc1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRlc3QoXCJSdWxlcyB0ZXN0LlwiLCBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gc2VsZi5ydW5UZXN0cygpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0sXHJcblxyXG4gIC8vIEludGVyZmFjZSBmb3IgdGVzdCBmdW5jdGlvbnM6XHJcbiAgLy8gICB0ZXN0LnJ1bGVzKHJ1bGVzUGF0aClcclxuICAvLyAgIHRlc3QuZGF0YWJhc2UoYXBwTmFtZSwgYXBwU2VjcmV0KVxyXG4gIC8vICAgdGVzdC51aWQodXNlcm5hbWUpXHJcbiAgLy8gICB0ZXN0KHRlc3ROYW1lLCB0ZXN0RnVuY3Rpb24pXHJcbiAgLy8gICB0ZXN0LlRJTUVTVEFNUFxyXG4gIGdldEludGVyZmFjZTogZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgdGVzdCA9IHRoaXMudGVzdC5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC5ydWxlcyA9IHRoaXMucnVsZXMuYmluZCh0aGlzKTtcclxuICAgIHRlc3QuZGF0YWJhc2UgPSB0aGlzLmRhdGFiYXNlLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LnVpZCA9IHRoaXMudWlkLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LlRJTUVTVEFNUCA9IHJlc3QuVElNRVNUQU1QO1xyXG4gICAgcmV0dXJuIHRlc3Q7XHJcbiAgfSxcclxuXHJcbiAgLy8gQ2FsbGVkIHdoZW4gcnVsZXMgYXJlIGdlbmVyYXRlZCBhbmQgdGVzdCBkYXRhYmFzZSBpcyBrbm93bi5cclxuICAvLyBBcmc6IFtydWxlc0pTT04sIHRydWVdXHJcbiAgb25SdWxlc1JlYWR5OiBmdW5jdGlvbihwcmVyZXEpIHtcclxuICAgIHRoaXMucnVsZXMgPSBwcmVyZXFbMF07XHJcbiAgICByZXR1cm4gdGhpcy5hZG1pbkNsaWVudC5wdXQocmVzdC5SVUxFU19MT0NBVElPTiwgdGhpcy5ydWxlcyk7XHJcbiAgfSxcclxuXHJcbiAgcnVuVGVzdHM6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2LCB0ZXN0KSB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRlc3QucnVuKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBwID0gbmV4dChwLCB0aGlzLnRlc3RzW2ldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcDtcclxuICB9LFxyXG5cclxuICB0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZm5UZXN0KSB7XHJcbiAgICB0aGlzLnRlc3RzLnB1c2gobmV3IFJ1bGVzVGVzdCh0ZXN0TmFtZSwgdGhpcywgZm5UZXN0KSk7XHJcbiAgfSxcclxuXHJcbiAgcnVsZXM6IGZ1bmN0aW9uKHJ1bGVzUGF0aCkge1xyXG4gICAgaWYgKHRoaXMucnVsZXNQYXRoKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgZXhwZWN0IGEgc2luZ2xlIGNhbGwgdG8gdGhlIHRlc3QucnVsZXMgZnVuY3Rpb24uXCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5ydWxlc1BhdGggPSBydWxlc1BhdGg7XHJcbiAgICB0aGlzLnJ1bGVzUGF0aFJlc29sdmUodXRpbC5lbnN1cmVFeHRlbnNpb24ocnVsZXNQYXRoLCBib2x0LkZJTEVfRVhURU5TSU9OKSk7XHJcbiAgfSxcclxuXHJcbiAgZGF0YWJhc2U6IGZ1bmN0aW9uKGFwcE5hbWUsIGFwcFNlY3JldCkge1xyXG4gICAgaWYgKHRoaXMuYWRtaW5DbGllbnQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5kYXRhYmFzZSBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLmFwcE5hbWUgPSBhcHBOYW1lO1xyXG4gICAgdGhpcy5hcHBTZWNyZXQgPSBhcHBTZWNyZXQ7XHJcbiAgICB0aGlzLmFkbWluQ2xpZW50ID0gdGhpcy5lbnN1cmVVc2VyKCdhZG1pbicpO1xyXG4gICAgdGhpcy5kYXRhYmFzZVJlYWR5KCk7XHJcbiAgfSxcclxuXHJcbiAgdWlkOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW5zdXJlVXNlcih1c2VybmFtZSkudWlkO1xyXG4gIH0sXHJcblxyXG4gIGVuc3VyZVVzZXI6IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XHJcbiAgICBpZiAoISh1c2VybmFtZSBpbiB0aGlzLnVzZXJzKSkge1xyXG4gICAgICBpZiAodXNlcm5hbWUgPT09ICdhbm9uJykge1xyXG4gICAgICAgIHRoaXMudXNlcnNbdXNlcm5hbWVdID0gbmV3IHJlc3QuQ2xpZW50KHRoaXMuYXBwTmFtZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFyIHRva2VuSW5mbztcclxuICAgICAgICB0b2tlbkluZm8gPSByZXN0LmdlbmVyYXRlVWlkQXV0aFRva2VuKHRoaXMuYXBwU2VjcmV0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBkZWJ1ZzogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRtaW46IHVzZXJuYW1lID09PSAnYWRtaW4nIH0pO1xyXG4gICAgICAgIHRoaXMudXNlcnNbdXNlcm5hbWVdID0gbmV3IHJlc3QuQ2xpZW50KHRoaXMuYXBwTmFtZSwgdG9rZW5JbmZvLnRva2VuLCB0b2tlbkluZm8udWlkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLnVzZXJzW3VzZXJuYW1lXTtcclxuICB9XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gUnVsZXNUZXN0KHRlc3ROYW1lLCBzdWl0ZSwgZm5UZXN0KSB7XHJcbiAgdGhpcy50ZXN0TmFtZSA9IHRlc3ROYW1lO1xyXG4gIHRoaXMuc3VpdGUgPSBzdWl0ZTtcclxuICB0aGlzLmZuVGVzdCA9IGZuVGVzdDtcclxuICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcclxuICB0aGlzLmxhc3RFcnJvciA9IHVuZGVmaW5lZDtcclxuICB0aGlzLnN0ZXBzID0gW107XHJcbiAgdGhpcy5mYWlsZWQgPSBmYWxzZTtcclxuXHJcbiAgLy8gQ3VycmVudCB1c2VyIGFuZCBwYXRoIChmb3IgcmVhZC93cml0ZSkuXHJcbiAgdGhpcy5wYXRoID0gdW5kZWZpbmVkO1xyXG4gIHRoaXMuYXV0aCA9IHVuZGVmaW5lZDtcclxufVxyXG5cclxudXRpbC5tZXRob2RzKFJ1bGVzVGVzdCwge1xyXG4gIHJ1bjogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLmRlYnVnKGZhbHNlKTtcclxuICAgIHRoaXMuYXMoJ2FkbWluJyk7XHJcbiAgICB0aGlzLmF0KCcvJyk7XHJcbiAgICB0aGlzLndyaXRlKG51bGwpO1xyXG4gICAgdGhpcy5zdWNjZWVkcyhcImluaXRpYWxpemF0aW9uXCIpO1xyXG5cclxuICAgIHRoaXMuYXQodW5kZWZpbmVkKTtcclxuICAgIHRoaXMuYXMoJ2Fub24nKTtcclxuXHJcbiAgICB0aGlzLmZuVGVzdCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLmRlYnVnKGZhbHNlKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlUXVldWUoKVxyXG4gICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJGaW5pc2hlZFwiKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgIHRoaXMubG9nKFwiRmFpbGVkOiBcIiArIGVycm9yKTtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgLy8gUXVldWUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgaW4gc2VxdWVuY2UgYWZ0ZXIgcHJldmlvdXMgc3RlcFxyXG4gIC8vIGluIHRlc3QgaXMgKHN1Y2Nlc3NmdWxseSkgY29tcGxldGVkLlxyXG4gIHF1ZXVlOiBmdW5jdGlvbihvcCwgYXJncywgZm4pIHtcclxuICAgIGlmICh0aGlzLmZhaWxlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBhcmdzID0gdXRpbC5jb3B5QXJyYXkoYXJncykubWFwKGZ1bmN0aW9uKHgpIHtcclxuICAgICAgcmV0dXJuIHV0aWwucHJldHR5SlNPTih4KTtcclxuICAgIH0pO1xyXG4gICAgdmFyIGxhYmVsID0gb3AgKyAnKCcgKyBhcmdzLmpvaW4oJywgJykgKyAnKSc7XHJcbiAgICB0aGlzLnN0ZXBzLnB1c2goe2xhYmVsOiBsYWJlbCwgZm46IGZufSk7XHJcbiAgfSxcclxuXHJcbiAgZXhlY3V0ZVF1ZXVlOiBmdW5jdGlvbigpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICB0aGlzLmxvZyhcIkV4ZWN1dGluZyAoXCIgKyB0aGlzLnN0ZXBzLmxlbmd0aCArIFwiIHN0ZXBzKVwiKTtcclxuICAgIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xyXG5cclxuICAgIGZ1bmN0aW9uIG5leHQocHJldiwgc3RlcCkge1xyXG4gICAgICByZXR1cm4gcHJldi50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHNlbGYubG9nKHN0ZXAubGFiZWwpO1xyXG4gICAgICAgIHJldHVybiBzdGVwLmZuKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zdGVwcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBwID0gbmV4dChwLCB0aGlzLnN0ZXBzW2ldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcDtcclxuICB9LFxyXG5cclxuICBkZWJ1ZzogZnVuY3Rpb24oZGVidWcpIHtcclxuICAgIHRoaXMuc3VpdGUuc2V0RGVidWcoZGVidWcpO1xyXG4gICAgdGhpcy5xdWV1ZSgnZGVidWcnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5zdWl0ZS5zZXREZWJ1ZyhkZWJ1Zyk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGFzOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgdmFyIGNsaWVudCA9IHRoaXMuc3VpdGUuZW5zdXJlVXNlcih1c2VybmFtZSk7XHJcbiAgICB0aGlzLnF1ZXVlKCdhcycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICB0aGlzLmNsaWVudCA9IGNsaWVudDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXQ6IGZ1bmN0aW9uKG9wUGF0aCkge1xyXG4gICAgdGhpcy5xdWV1ZSgnYXQnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5wYXRoID0gb3BQYXRoO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICB3cml0ZTogZnVuY3Rpb24ob2JqKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQucHV0KHRoaXMucGF0aCwgb2JqKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBwdXNoOiBmdW5jdGlvbihvYmopIHtcclxuICAgIHRoaXMucXVldWUoJ3dyaXRlJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGxldCBwYXRoID0gdGhpcy5wYXRoO1xyXG4gICAgICBpZiAocGF0aC5zbGljZSgtMSlbMF0gIT09ICcvJykge1xyXG4gICAgICAgIHBhdGggKz0gJy8nO1xyXG4gICAgICB9XHJcbiAgICAgIHBhdGggKz0gcmVzdC5nZW5lcmF0ZVB1c2hJRCgpO1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQucHV0KHBhdGgsIG9iailcclxuICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgcmVhZDogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdyZWFkJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5nZXQodGhpcy5wYXRoKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBzdWNjZWVkczogZnVuY3Rpb24obWVzc2FnZSkge1xyXG4gICAgdGhpcy5xdWV1ZSgnc3VjY2VlZHMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgYXNzZXJ0KHRoaXMuc3RhdHVzID09PSB0cnVlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgc3VjY2VlZClcXG5cIiArIHRoaXMubGFzdEVycm9yKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGZhaWxzOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdmYWlscycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICBhc3NlcnQodGhpcy5zdGF0dXMgPT09IGZhbHNlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgZmFpbGVkKVwiKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGdvb2Q6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHRoaXMubG9nKG1lc3NhZ2UgKyBcIiAoQ29ycmVjdClcIik7XHJcbiAgfSxcclxuXHJcbiAgbG9nOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICBpZiAodGhpcy5zdWl0ZS5kZWJ1Zykge1xyXG4gICAgICBjb25zb2xlLmxvZyh0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSkpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG1lc3NhZ2VGb3JtYXQ6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHJldHVybiB0aGlzLnN1aXRlLnN1aXRlTmFtZSArIFwiLlwiICsgdGhpcy50ZXN0TmFtZSArIFwiIFwiICsgbWVzc2FnZTtcclxuICB9XHJcbn0pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
