"use strict";
var Promise = require('promise');
var chai = require('chai');
var assert = chai.assert;
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = (typeof window !== 'undefined' && window.bolt) || require('./bolt');
var secrets = require('../auth-secrets.json');
var MAX_TEST_MS = 60000;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
function RulesSuite(suiteName, fnSuite) {
    this.suiteName = suiteName;
    this.fnSuite = fnSuite;
    this.users = {};
    this.tests = [];
    this.debug = false;
}
util.methods(RulesSuite, {
    setDebug: function (debug) {
        if (debug === undefined) {
            debug = false;
        }
        this.debug = debug;
        return this;
    },
    run: function () {
        var self = this;
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = bolt.generate(util.getProp(fileIO.readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database]).then(self.onRulesReady.bind(self));
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    },
    getInterface: function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    },
    onRulesReady: function (prereq) {
        this.rules = prereq[0];
        return this.adminClient.put(rest.RULES_LOCATION, this.rules);
    },
    runTests: function () {
        var p = Promise.resolve(true);
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    },
    test: function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    },
    rules: function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    },
    database: function (appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appSecret = appSecret;
        this.adminClient = new rest.Client(secrets.appName, secrets.secret);
        this.databaseReady();
    },
    uid: function (username) {
        return this.users[username].uid;
    },
    ensureUser: function (username) {
        if (!(username in this.users)) {
            var clientInfo;
            if (username === 'admin') {
                clientInfo = new rest.Client(secrets.appName, secrets.secret);
            }
            else {
                clientInfo = rest.createFirebaseDbRefForUser(username);
            }
            this.users[username] = clientInfo;
        }
        return this.users[username];
    }
});
function RulesTest(testName, suite, fnTest) {
    this.testName = testName;
    this.suite = suite;
    this.fnTest = fnTest;
    this.status = undefined;
    this.lastError = undefined;
    this.steps = [];
    this.failed = false;
    this.path = undefined;
    this.auth = undefined;
}
util.methods(RulesTest, {
    run: function () {
        var _this = this;
        this.debug(true);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        this.debug(false);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    },
    queue: function (op, args, fn) {
        if (this.failed) {
            return;
        }
        args = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + args.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    },
    executeQueue: function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                console.log(step.label);
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    },
    debug: function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
        });
        return this;
    },
    as: function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        console.log('##### Ensure User:' + username);
        this.queue('as', arguments, function () {
            _this.client = client;
            _this.username = username;
        });
        return this;
    },
    at: function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
        });
        return this;
    },
    write: function (obj) {
        var _this = this;
        var self = this;
        this.queue('write', arguments, function () {
            var tmp;
            if (_this.username === 'admin') {
                console.log(_this);
                tmp = _this.client.put(_this.path, obj)
                    .then(function () {
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            else {
                tmp = _this.client.database().ref(_this.path).set(obj)
                    .then(function () {
                    _this.status = true;
                })
                    .catch(function (error) {
                    _this.status = false;
                    _this.lastError = error;
                });
            }
            return tmp;
        });
        return this;
    },
    push: function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            var path = _this.path;
            return _this.client.database().ref(_this.path).push(obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    read: function () {
        var _this = this;
        this.queue('read', arguments, function () {
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    },
    succeeds: function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    fails: function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
        });
        return this;
    },
    good: function (message) {
        this.log(message + " (Correct)");
    },
    log: function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    },
    messageFormat: function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    }
});

//# sourceMappingURL=data:application/json;base64,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RixDQUFDLENBQUMiLCJmaWxlIjoic2ltdWxhdG9yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogRmlyZWJhc2UgUnVsZXMgdGVzdCBzaW11bGF0b3IuXHJcbiAqXHJcbiAqIENvcHlyaWdodCAyMDE1IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbiAqXHJcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3Mvbm9kZS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvY2hhaS5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cInR5cGluZ3MvbW9jaGEuZC50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJ0eXBpbmdzL2VzNi1wcm9taXNlLmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IFByb21pc2UgPSByZXF1aXJlKCdwcm9taXNlJyk7XHJcbmltcG9ydCBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xyXG52YXIgYXNzZXJ0ID0gY2hhaS5hc3NlcnQ7XHJcbmltcG9ydCByZXN0ID0gcmVxdWlyZSgnLi9maXJlYmFzZS1yZXN0Jyk7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XHJcbmltcG9ydCBmaWxlSU8gPSByZXF1aXJlKCcuL2ZpbGUtaW8nKTtcclxuaW1wb3J0IGZpcmViYXNlID0gcmVxdWlyZSgnZmlyZWJhc2UnKTtcclxuXHJcbi8vIEJyb3dzZXJpZnkgYnVnOiBodHRwczovL2dpdGh1Yi5jb20vc3Vic3RhY2svbm9kZS1icm93c2VyaWZ5L2lzc3Vlcy8xMTUwXHJcbmludGVyZmFjZSBXaW5kb3cgeyBib2x0OiBhbnk7IH1cclxuZGVjbGFyZSB2YXIgd2luZG93OiBXaW5kb3c7XHJcbnZhciBib2x0ID0gKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5ib2x0KSB8fCByZXF1aXJlKCcuL2JvbHQnKTtcclxudmFyIHNlY3JldHMgPSByZXF1aXJlKCcuLi9hdXRoLXNlY3JldHMuanNvbicpO1xyXG52YXIgTUFYX1RFU1RfTVMgPSA2MDAwMDtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBydWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkge1xyXG4gIG5ldyBSdWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkucnVuKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIFJ1bGVzU3VpdGUoc3VpdGVOYW1lLCBmblN1aXRlKSB7XHJcbiAgdGhpcy5zdWl0ZU5hbWUgPSBzdWl0ZU5hbWU7XHJcbiAgdGhpcy5mblN1aXRlID0gZm5TdWl0ZTtcclxuICB0aGlzLnVzZXJzID0ge307XHJcbiAgdGhpcy50ZXN0cyA9IFtdO1xyXG4gIHRoaXMuZGVidWcgPSBmYWxzZTtcclxufVxyXG5cclxudXRpbC5tZXRob2RzKFJ1bGVzU3VpdGUsIHtcclxuICBzZXREZWJ1ZzogZnVuY3Rpb24oZGVidWcpIHtcclxuICAgIGlmIChkZWJ1ZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGRlYnVnID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICB0aGlzLmRlYnVnID0gZGVidWc7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBydW46IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIC8vIFJ1biBNb2NoYSBUZXN0IFN1aXRlIC0gc2VyaWFsaXplIHdpdGggYW55IG90aGVyIG1vY2hhIHRlc3Qgc3VpdGVzLlxyXG4gICAgc3VpdGUoXCJGaXJlYmFzZSBSdWxlcyBTaW11bGF0b3I6IFwiICsgc2VsZi5zdWl0ZU5hbWUsIGZ1bmN0aW9uKCkge1xyXG4gICAgICB0aGlzLnRpbWVvdXQoTUFYX1RFU1RfTVMpO1xyXG4gICAgICBzdWl0ZVNldHVwKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBydWxlc1BhdGggPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XHJcbiAgICAgICAgICBzZWxmLnJ1bGVzUGF0aFJlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgZGF0YWJhc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XHJcbiAgICAgICAgICBzZWxmLmRhdGFiYXNlUmVhZHkgPSByZXNvbHZlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgcnVsZXNKU09OID0gYm9sdC5nZW5lcmF0ZSh1dGlsLmdldFByb3AoZmlsZUlPLnJlYWRGaWxlKHJ1bGVzUGF0aCksICdjb250ZW50JykpO1xyXG5cclxuICAgICAgICAvLyBKVCAtIFRPRE86IE5vdCBzdXJlIHdoeSBJIG5lZWRlZCB0byBkaXNhYmxlIHRoaXMuXHJcbiAgICAgICAgc2VsZi5yZWFkeSA9IFByb21pc2UuYWxsKFtydWxlc0pTT04sIGRhdGFiYXNlXSkudGhlbihzZWxmLm9uUnVsZXNSZWFkeS5iaW5kKHNlbGYpKTtcclxuXHJcbiAgICAgICAgLy8gRXhlY3V0ZSBpbml0aWFsaXphdGlvbiBhbmQgZ2V0IHRlc3QgZGVmaW5pdGlvbnMgKGluIGNsaWVudCBjb2RlKS5cclxuICAgICAgICBzZWxmLmZuU3VpdGUoc2VsZi5nZXRJbnRlcmZhY2UoKSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzZWxmLnJlYWR5O1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRlc3QoXCJJbml0aWFsaXphdGlvbi5cIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgLy8gcGFzc1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRlc3QoXCJSdWxlcyB0ZXN0LlwiLCBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gc2VsZi5ydW5UZXN0cygpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0sXHJcblxyXG4gIC8vIEludGVyZmFjZSBmb3IgdGVzdCBmdW5jdGlvbnM6XHJcbiAgLy8gICB0ZXN0LnJ1bGVzKHJ1bGVzUGF0aClcclxuICAvLyAgIHRlc3QuZGF0YWJhc2UoYXBwTmFtZSwgYXBwU2VjcmV0KVxyXG4gIC8vICAgdGVzdC51aWQodXNlcm5hbWUpXHJcbiAgLy8gICB0ZXN0KHRlc3ROYW1lLCB0ZXN0RnVuY3Rpb24pXHJcbiAgLy8gICB0ZXN0LlRJTUVTVEFNUFxyXG4gIGdldEludGVyZmFjZTogZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgdGVzdCA9IHRoaXMudGVzdC5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC5ydWxlcyA9IHRoaXMucnVsZXMuYmluZCh0aGlzKTtcclxuICAgIHRlc3QuZGF0YWJhc2UgPSB0aGlzLmRhdGFiYXNlLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LnVpZCA9IHRoaXMudWlkLmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LlRJTUVTVEFNUCA9IHJlc3QuVElNRVNUQU1QO1xyXG4gICAgcmV0dXJuIHRlc3Q7XHJcbiAgfSxcclxuXHJcbiAgLy8gQ2FsbGVkIHdoZW4gcnVsZXMgYXJlIGdlbmVyYXRlZCBhbmQgdGVzdCBkYXRhYmFzZSBpcyBrbm93bi5cclxuICAvLyBBcmc6IFtydWxlc0pTT04sIHRydWVdXHJcbiAgb25SdWxlc1JlYWR5OiBmdW5jdGlvbihwcmVyZXEpIHtcclxuICAgIHRoaXMucnVsZXMgPSBwcmVyZXFbMF07XHJcbiAgICByZXR1cm4gdGhpcy5hZG1pbkNsaWVudC5wdXQocmVzdC5SVUxFU19MT0NBVElPTiwgdGhpcy5ydWxlcyk7XHJcbiAgfSxcclxuXHJcbiAgcnVuVGVzdHM6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2LCB0ZXN0KSB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRlc3QucnVuKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBwID0gbmV4dChwLCB0aGlzLnRlc3RzW2ldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcDtcclxuICB9LFxyXG5cclxuICB0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZm5UZXN0KSB7XHJcbiAgICB0aGlzLnRlc3RzLnB1c2gobmV3IFJ1bGVzVGVzdCh0ZXN0TmFtZSwgdGhpcywgZm5UZXN0KSk7XHJcbiAgfSxcclxuXHJcbiAgcnVsZXM6IGZ1bmN0aW9uKHJ1bGVzUGF0aCkge1xyXG4gICAgaWYgKHRoaXMucnVsZXNQYXRoKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgZXhwZWN0IGEgc2luZ2xlIGNhbGwgdG8gdGhlIHRlc3QucnVsZXMgZnVuY3Rpb24uXCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5ydWxlc1BhdGggPSBydWxlc1BhdGg7XHJcbiAgICB0aGlzLnJ1bGVzUGF0aFJlc29sdmUodXRpbC5lbnN1cmVFeHRlbnNpb24ocnVsZXNQYXRoLCBib2x0LkZJTEVfRVhURU5TSU9OKSk7XHJcbiAgfSxcclxuXHJcbiAgZGF0YWJhc2U6IGZ1bmN0aW9uKGFwcFNlY3JldCkge1xyXG4gICAgaWYgKHRoaXMuYWRtaW5DbGllbnQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5kYXRhYmFzZSBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLmFwcFNlY3JldCA9IGFwcFNlY3JldDtcclxuICAgIHRoaXMuYWRtaW5DbGllbnQgPSBuZXcgcmVzdC5DbGllbnQoc2VjcmV0cy5hcHBOYW1lLHNlY3JldHMuc2VjcmV0KTsgLy8gdXNpbmcgY2xhc3NpYyByZXN0IGludGVyZmFjZSBzdGlsbFxyXG4gICAgdGhpcy5kYXRhYmFzZVJlYWR5KCk7XHJcbiAgfSxcclxuXHJcbiAgdWlkOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlcnNbdXNlcm5hbWVdLnVpZDtcclxuICB9LFxyXG5cclxuICBlbnN1cmVVc2VyOiBmdW5jdGlvbih1c2VybmFtZSkge1xyXG4gICAgaWYgKCEodXNlcm5hbWUgaW4gdGhpcy51c2VycykpIHtcclxuICAgICAgICB2YXIgY2xpZW50SW5mb1xyXG4gICAgICAgIGlmKHVzZXJuYW1lID09PSAnYWRtaW4nKXtcclxuICAgICAgICAgICAgY2xpZW50SW5mbyA9IG5ldyByZXN0LkNsaWVudChzZWNyZXRzLmFwcE5hbWUsIHNlY3JldHMuc2VjcmV0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY2xpZW50SW5mbyA9IHJlc3QuY3JlYXRlRmlyZWJhc2VEYlJlZkZvclVzZXIodXNlcm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVzZXJzW3VzZXJuYW1lXSA9IGNsaWVudEluZm87XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy51c2Vyc1t1c2VybmFtZV07XHJcbiAgfVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIFJ1bGVzVGVzdCh0ZXN0TmFtZSwgc3VpdGUsIGZuVGVzdCkge1xyXG4gIHRoaXMudGVzdE5hbWUgPSB0ZXN0TmFtZTtcclxuICB0aGlzLnN1aXRlID0gc3VpdGU7XHJcbiAgdGhpcy5mblRlc3QgPSBmblRlc3Q7XHJcbiAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5sYXN0RXJyb3IgPSB1bmRlZmluZWQ7XHJcbiAgdGhpcy5zdGVwcyA9IFtdO1xyXG4gIHRoaXMuZmFpbGVkID0gZmFsc2U7XHJcblxyXG4gIC8vIEN1cnJlbnQgdXNlciBhbmQgcGF0aCAoZm9yIHJlYWQvd3JpdGUpLlxyXG4gIHRoaXMucGF0aCA9IHVuZGVmaW5lZDtcclxuICB0aGlzLmF1dGggPSB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbnV0aWwubWV0aG9kcyhSdWxlc1Rlc3QsIHtcclxuICBydW46IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5kZWJ1Zyh0cnVlKTtcclxuICAgIC8vIEpUOiBUaGlzIGlzIG5vdCB3b3JraW5nIHByb3Blcmx5IGJlbG93XHJcbiAgICB0aGlzLmFzKCdhZG1pbicpO1xyXG4gICAgdGhpcy5hdCgnLycpO1xyXG4gICAgdGhpcy53cml0ZShudWxsKTsgLy8gQ2xlYXIgb3V0IGFueSBleGlzdGluZyBkYXRhXHJcbiAgICB0aGlzLnN1Y2NlZWRzKFwiaW5pdGlhbGl6YXRpb25cIik7XHJcbiAgICB0aGlzLmF0KHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLmFzKCdhbm9uJyk7XHJcbiAgICB0aGlzLmZuVGVzdCh0aGlzKTtcclxuICAgIHRoaXMuZGVidWcoZmFsc2UpO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVRdWV1ZSgpXHJcbiAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvZyhcIkZpbmlzaGVkXCIpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJGYWlsZWQ6IFwiICsgZXJyb3IpO1xyXG4gICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICB9KTtcclxuICB9LFxyXG5cclxuICAvLyBRdWV1ZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpbiBzZXF1ZW5jZSBhZnRlciBwcmV2aW91cyBzdGVwXHJcbiAgLy8gaW4gdGVzdCBpcyAoc3VjY2Vzc2Z1bGx5KSBjb21wbGV0ZWQuXHJcbiAgcXVldWU6IGZ1bmN0aW9uKG9wLCBhcmdzLCBmbikge1xyXG4gICAgaWYgKHRoaXMuZmFpbGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGFyZ3MgPSB1dGlsLmNvcHlBcnJheShhcmdzKS5tYXAoZnVuY3Rpb24oeCkge1xyXG4gICAgICByZXR1cm4gdXRpbC5wcmV0dHlKU09OKHgpO1xyXG4gICAgfSk7XHJcbiAgICB2YXIgbGFiZWwgPSBvcCArICcoJyArIGFyZ3Muam9pbignLCAnKSArICcpJztcclxuICAgIHRoaXMuc3RlcHMucHVzaCh7bGFiZWw6IGxhYmVsLCBmbjogZm59KTtcclxuICB9LFxyXG5cclxuICBleGVjdXRlUXVldWU6IGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHRoaXMubG9nKFwiRXhlY3V0aW5nIChcIiArIHRoaXMuc3RlcHMubGVuZ3RoICsgXCIgc3RlcHMpXCIpO1xyXG4gICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2LCBzdGVwKSB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coc3RlcC5sYWJlbCk7XHJcbiAgICAgICAgc2VsZi5sb2coc3RlcC5sYWJlbCk7XHJcbiAgICAgICAgcmV0dXJuIHN0ZXAuZm4oKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnN0ZXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIHAgPSBuZXh0KHAsIHRoaXMuc3RlcHNbaV0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwO1xyXG4gIH0sXHJcblxyXG4gIGRlYnVnOiBmdW5jdGlvbihkZWJ1Zykge1xyXG4gICAgdGhpcy5zdWl0ZS5zZXREZWJ1ZyhkZWJ1Zyk7XHJcbiAgICB0aGlzLnF1ZXVlKCdkZWJ1ZycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICB0aGlzLnN1aXRlLnNldERlYnVnKGRlYnVnKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXM6IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XHJcbiAgICB2YXIgY2xpZW50ID0gdGhpcy5zdWl0ZS5lbnN1cmVVc2VyKHVzZXJuYW1lKTtcclxuICAgIGNvbnNvbGUubG9nKCcjIyMjIyBFbnN1cmUgVXNlcjonICsgdXNlcm5hbWUpO1xyXG4gICAgdGhpcy5xdWV1ZSgnYXMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XHJcbiAgICAgIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgYXQ6IGZ1bmN0aW9uKG9wUGF0aCkge1xyXG4gICAgdGhpcy5xdWV1ZSgnYXQnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5wYXRoID0gb3BQYXRoO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG4vLyBUT0RPOiBDbGVhbnVwLiBUaGVyZSdzIGdvdCB0byBiZSBhIGJldHRlciBhZG1pbiBVSSBmb3IgZG9pbmcgdGhpc1xyXG4gIHdyaXRlOiBmdW5jdGlvbihvYmopIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICB2YXIgdG1wO1xyXG4gICAgICBpZih0aGlzLnVzZXJuYW1lID09PSAnYWRtaW4nKXtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzKTtcclxuICAgICAgICB0bXAgPSB0aGlzLmNsaWVudC5wdXQodGhpcy5wYXRoLCBvYmopXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZXtcclxuICAgICAgIHRtcCA9IHRoaXMuY2xpZW50LmRhdGFiYXNlKCkucmVmKHRoaXMucGF0aCkuc2V0KG9iailcclxuICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0bXA7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG4vLyBUT0RPOiBSZS13cml0ZSB0aGlzIG92ZXIgdG8gdGhlIGNsaWVudCBhcGlcclxuICBwdXNoOiBmdW5jdGlvbihvYmopIHtcclxuICAgIHRoaXMucXVldWUoJ3dyaXRlJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGxldCBwYXRoID0gdGhpcy5wYXRoO1xyXG5cclxuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRhdGFiYXNlKCkucmVmKHRoaXMucGF0aCkucHVzaChvYmopXHJcbiAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgIH0pXHJcbiAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfSxcclxuXHJcbiAgcmVhZDogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdyZWFkJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5nZXQodGhpcy5wYXRoKVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9LFxyXG5cclxuICBzdWNjZWVkczogZnVuY3Rpb24obWVzc2FnZSkge1xyXG4gICAgdGhpcy5xdWV1ZSgnc3VjY2VlZHMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgYXNzZXJ0KHRoaXMuc3RhdHVzID09PSB0cnVlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgc3VjY2VlZClcXG5cIiArIHRoaXMubGFzdEVycm9yKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGZhaWxzOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICB0aGlzLnF1ZXVlKCdmYWlscycsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICBhc3NlcnQodGhpcy5zdGF0dXMgPT09IGZhbHNlLFxyXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgZmFpbGVkKVwiKSk7XHJcbiAgICAgIHRoaXMuZ29vZChtZXNzYWdlKTtcclxuICAgICAgdGhpcy5zdGF0dXMgPSB1bmRlZmluZWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIGdvb2Q6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHRoaXMubG9nKG1lc3NhZ2UgKyBcIiAoQ29ycmVjdClcIik7XHJcbiAgfSxcclxuXHJcbiAgbG9nOiBmdW5jdGlvbihtZXNzYWdlKSB7XHJcbiAgICBpZiAodGhpcy5zdWl0ZS5kZWJ1Zykge1xyXG4gICAgICBjb25zb2xlLmxvZyh0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSkpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG1lc3NhZ2VGb3JtYXQ6IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcclxuICAgIHJldHVybiB0aGlzLnN1aXRlLnN1aXRlTmFtZSArIFwiLlwiICsgdGhpcy50ZXN0TmFtZSArIFwiIFwiICsgbWVzc2FnZTtcclxuICB9XHJcbn0pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
